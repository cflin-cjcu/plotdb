{"ownername":"plotdb","key":1039,"name":"Sankey Chord","owner":4,"theme":null,"parent":null,"description":"hybrid sankey chart with chord diagram","basetype":["6","12"],"visualencoding":["5","6"],"category":["1","4","5"],"tags":["chord","sankey","relation","relationship"],"likes":null,"searchable":true,"dimlen":3,"createdtime":"2016-04-17T13:24:25.000Z","modifiedtime":"2016-10-09T09:18:44.000Z","doc":{"name":"document","size":0,"type":"html","lines":1,"content":""},"style":{"name":"stylesheet","size":0,"type":"css","lines":1,"content":""},"code":{"name":"code","size":13388,"type":"javascript","lines":321,"content":"{\n  sample: function() {\n    var list = d3.range(40 + Math.round(Math.random() * 9));\n    var continents = [\"Asia\",\"North America\",\"South America\",\"Africa\",\"Europe\",\"Australia\",\"Oceania\"];\n    continents.splice(0, Math.round(Math.random() * 3));\n    return {\n      src: [{name: \"Continent\", data: list.map(function(d,i) { return continents[i % continents.length]; })}],\n      des: [{name: \"Continent\", data: list.map(function(d,i) { return continents[parseInt(i / continents.length)]; })}],\n      size: [{name: \"Value\", data: list.map(function(d,i) { return Math.round(100 * Math.random()); })}]\n    };\n  },\n  dimension: {\n    src: { type: [], require: true, desc: \"name of source node\" },\n    des: { type: [], require: true, desc: \"name of destination node\" },\n    size: { type: [plotdb.Number], require: true, desc: \"flow size\" }\n  },\n  config: {\n    fontFamily: {},\n    background: {},\n    textFill: {},\n    fontSize: {},\n    palette: {},\n    labelShow: {default: true},\n    stroke: {default: \"#fff\"},\n    strokeWidth: {default: 1},\n    otherLimit: {rebindOnChange: true},\n    otherLabel: {rebindOnChange: true},\n    thick: { name: \"Thickness\", type: [plotdb.Number], default: 20 },\n  },\n  init: function() {\n    var that = this, it;\n    this.svg = d3.select(this.root).append(\"svg\");\n    this.srcGroup = this.svg.append(\"g\").attr({class: \"src arc\"});\n    this.desGroup = this.svg.append(\"g\").attr({class: \"des arc\"});\n    this.chordGroup = this.svg.append(\"g\").attr({class: \"chord connect arc\"});\n    this.popupChord = plotd3.html.popup(this.root).on(\"mousemove\", function(d,i,popup) {\n      if(d.src || d.des) {\n        popup.select(\".value:nth-of-type(1)\").text(d.src);\n        popup.select(\".value:nth-of-type(2)\").text(\"â†“ ( \" + d.size +\" )\");\n        popup.select(\".value:nth-of-type(3)\").text(d.des);\n      } else {\n        popup.select(\".value:nth-of-type(1)\").text(d.key);\n        popup.select(\".value:nth-of-type(2)\").text(d.sum);\n        popup.select(\".value:nth-of-type(3)\").text(\"(\"+Math.round(100 * d.percent) + \"%)\");\n      }\n    });\n    this.popupChord.getPopupNode().call(function(d,i) {\n      this.select(\".title\").remove();\n      this.append(\"div\").attr({class: \"value\"});\n      this.append(\"div\").attr({class: \"value\"});\n    });\n    this.arc = d3.svg.arc();\n  },\n  parse: function() {\n    var that = this;\n    var dessize = {}, srcsize = {};\n    if(!this.dimension.src.fields.length) this.data.map(function(d,i) { d.src = \"?\"; });\n    if(!this.dimension.des.fields.length) this.data.map(function(d,i) { d.des = \"?\"; });\n    if(!this.dimension.size.fields.length) this.data.map(function(d,i) { d.size = 1; });\n    this.data = this.data.filter(function(it) { return it.src && it.des; });\n    this.data.forEach(function(d,i) {\n      dessize[d.des] = (dessize[d.des] || 0) + d.size;\n      srcsize[d.src] = (srcsize[d.src] || 0) + d.size;\n    });\n    this.data.forEach(function(d,i) {\n      if(dessize[d.des] < that.config.otherLimit) d.des = that.config.otherLabel;\n      if(srcsize[d.src] < that.config.otherLimit) d.src = that.config.otherLabel;\n    });\n    dessize = {}, srcsize = {};\n    this.data.forEach(function(d,i) {\n      dessize[d.des] = (dessize[d.des] || 0) + d.size;\n      srcsize[d.src] = (srcsize[d.src] || 0) + d.size;\n    });\n    var dsmap = {};\n    var parsed = [];\n    this.data.forEach(function(d,i) {\n      var name = \"[\" + d.src +\"][\" + d.des + \"]\";\n      if(!dsmap[name]) {\n        dsmap[name] = {src: d.src, des: d.des, size: 0};\n        parsed.push(dsmap[name]);\n      }\n      dsmap[name].size += d.size;\n    });\n    this.data = parsed;\n    this.nameLen = d3.max(this.data.map(function(it) { return [it.src, it.des]; })\n      .reduce(function(a,b) { return a.concat(b); }, [])\n      .map(function(it) { return (it || \"\").length; }));\n    var mapper = function(key) {\n      var ret = d3.nest().key(function(it) { return it[key]; }).entries(that.data).map(function(it) {\n        it.sum = it.values.reduce(function(a,b) { return a + b.size; }, 0);\n        return it;\n      });\n      var total = ret.reduce(function(a,b) { return a + b.sum; }, 0);\n      var offset = 0;\n      ret.sort(function(a,b) { return b.sum - a.sum; });\n      for(var i = 0; i < ret.length; i++) {\n        it = ret[i];\n        it.percent = it.sum / total;\n        it.offset = offset;\n        it._offset = 0;\n        offset += it.percent;\n        it.side = key;\n      }\n      return ret;\n    };\n    this.srcmap = mapper(\"src\");\n    this.desmap = mapper(\"des\");\n    this.data.sort(function(a,b) {\n      var ret = dessize[b.des] - dessize[a.des];\n      if(ret!=0) return ret;\n      return srcsize[b.src] - srcsize[a.src];\n    });\n    for(var i = 0, src, des; i < this.data.length; i++) {\n      it = this.data[i];\n      src = this.srcmap.filter(function(v) { return v.key == it.src; })[0];\n      des = this.desmap.filter(function(v) { return v.key == it.des; })[0];\n      it.coord = {\n        src: {node: src, offset: src._offset, percent: it.size / src.sum },\n        des: {node: des, offset: des._offset, percent: it.size / des.sum }\n      };\n      src._offset += (it.size / src.sum);\n      des._offset += (it.size / des.sum);\n    }\n  },\n  bind: function() {\n    var that = this,sel,n1,n2;\n    sel = this.srcGroup.selectAll(\"path.arc.src\").data(this.srcmap);\n    sel.exit().remove();\n    n1 = sel.enter().append(\"path\").attr({class: \"arc src\"});\n    sel = this.desGroup.selectAll(\"path.arc.des\").data(this.desmap);\n    sel.exit().remove();\n    n2 = sel.enter().append(\"path\").attr({class: \"arc des\"});\n    sel = this.chordGroup.selectAll(\"path.chord\").data(this.data);\n    sel.exit().remove();\n    sel.enter().append(\"path\").attr({class: \"chord\"});\n    sel = this.svg.selectAll(\"text.label.src\").data(this.srcmap);\n    sel.exit().remove();\n    sel.enter().append(\"text\").attr({class: \"label src\"});\n    sel = this.svg.selectAll(\"text.label.des\").data(this.desmap);\n    sel.exit().remove();\n    sel.enter().append(\"text\").attr({class: \"label des\"});\n    this.popupChord.nodes(this.svg.selectAll(\"path.chord\"));\n    this.popupChord.nodes(n1).nodes(n2);\n    this.svg.selectAll(\"path.chord\").on(\"mouseover\", function(d,i) {\n      if(that.handle) {\n        clearTimeout(that.handle);\n        that.handle = null;\n      }\n      that.target = {src: d.src, side: null, des: d.des};\n      that.render();\n    }).on(\"mouseout\", function(d,i) {\n      that.handle = setTimeout(function() {\n        that.target = null; \n        that.render();\n      }, 200);\n    });\n    this.svg.selectAll(\"path.arc\").on(\"mouseover\", function(d,i) {\n      if(that.handle) {\n        clearTimeout(that.handle);\n        that.handle = null;\n      }\n      that.target = {src: d.src || d.key, side: d.side, des: d.des || d.key};\n      that.render();\n    }).on(\"mouseout\", function(d,i) {\n      that.handle = setTimeout(function() {\n        that.target = null; \n        that.render();\n      }, 200);\n    });\n  },\n  resize: function() {\n    var that = this;\n    var box = this.root.getBoundingClientRect();\n    var width = this.width = box.width;\n    var height = this.height = box.height;\n    this.svg.attr({\n      width: width + \"px\", height: height + \"px\",\n      viewBox: [0,0,width,height].join(\" \"),\n      preserveAspectRatio: \"xMidYMid\"\n    });\n    this.popupChord.fontSize(this.config.fontSize);\n    this.thick = this.config.thick * ( this.width < 640 ? 0.5 : 1);\n    this.srcAscale = d3.scale.linear().domain([0,1]).range([-Math.PI/6,-Math.PI*5/6]);\n    this.desAscale = d3.scale.linear().domain([0,1]).range([Math.PI/6,Math.PI*5/6]);\n    this.color = d3.scale.ordinal().range(that.config.palette.colors.map(function(it) { return it.hex; }));\n  },\n  render: function() {\n    var that = this,sel;\n    if(this.config.fontFamily) d3.select(this.root).style(\"font-family\", this.config.fontFamily);\n    d3.select(this.root).style(\"background-color\", this.config.background);\n    this.svg.selectAll(\"text\").attr({\n      \"font-size\": that.config.fontSize,\n      \"fill\": that.config.textFill\n    });\n    this.svg.selectAll(\"text.label\").attr({\n      \"font-size\": that.config.fontSize,\n      display: that.config.labelShow\n    }).text(function(d,i) { return d.key; });\n    this.labelSize = d3.max(this.svg.selectAll(\"text.label\")[0].map(function(d) { return d.getBoundingClientRect().width; }));\n    if(!this.config.labelShow) this.labelSize = 0;\n    var mw = this.width - this.labelSize * 2 - this.config.fontSize * 2; //this.config.fontSize * ( this.nameLen + 5);\n    var mh = this.height - this.config.fontSize * 2;\n    var size = this.size = (mw > mh ? mh : mw ) / 2\n\n    this.arc.innerRadius(size - this.thick).outerRadius(size);\n\n    this.svg.selectAll(\"text.label\").attr({\n      transform: function(d,i) {\n        var scale = (d3.select(this).classed(\"src\") ? that.srcAscale : that.desAscale);\n        var a = ( scale(d.offset) + scale(d.offset + d.percent)) / 2;\n        var x = Math.sin(a) * (that.size + that.config.fontSize);\n        var y = -Math.cos(a) * (that.size + that.config.fontSize * 1.5);\n        return [\n          \"translate(\",\n          x + that.width / 2,\n          y + that.height / 2,\n          \")\"\n        ].join(\" \");\n      },\n      \"text-anchor\": function(d,i) {\n        return d3.select(this).classed(\"src\") ? \"end\" : \"start\";\n      },\n      dy: \"0.38em\",\n      dx: function(d,i) {\n        return that.config.fontSize * (d3.select(this).classed(\"src\") ? -0 : 0);\n      },\n      \"font-size\": that.config.fontSize,\n      display: that.config.labelShow ? \"block\" : \"none\"\n    }).text(function(d,i) { return d.key; });\n    this.svg.selectAll(\"g.arc\").filter(function() { return !d3.select(this).attr(\"transform\"); }).attr({\n      opacity: 0,\n    });\n    this.svg.selectAll(\"g.arc\").transition(\"opacity\").duration(500).attr({opacity: 1});\n    this.svg.selectAll(\"g.arc\").each(function(d,i) {\n      var node = d3.select(this), path = node.selectAll(\"path.arc\");\n      if(node.attr(\"transform\")) node = node.transition(\"morph\").duration(500);\n\n      node.attr({\n        transform: \"translate(\" + (that.width /2) + \",\" + (that.height / 2) + \")\",\n      });\n      path.each(function() {\n        var node = d3.select(this);\n        if(node.attr(\"d\")) node = node.transition(\"morph\").duration(500);\n        else node.attr({opacity: 0});\n        node.attr({\n          fill: function(d,i) {\n            return that.color(d.key);\n          },\n          stroke: that.config.stroke,\n          \"stroke-width\": that.config.strokeWidth,\n          d: function(d,i) {\n            var scale = (d3.select(this).classed(\"src\") ? that.srcAscale : that.desAscale);\n            return that.arc.startAngle(scale(d.offset)).endAngle(scale(d.offset + d.percent))();\n          },\n        });\n      });\n    });\n    this.svg.selectAll(\"path.arc\").transition(\"opacity\").duration(500).attr({\n      opacity: function(d,i) {\n        var issrc = d3.select(this).classed(\"src\");\n        return (!that.target || (\n          (issrc && that.target.side == \"src\" && d.key == that.target.src) || \n          (!issrc && that.target.side == \"des\" && d.key == that.target.des) ||\n          (that.target.side == null && (\n            (d.key == that.target.src && issrc) ||\n            (d.key == that.target.des && !issrc)\n          ))\n        ) ? 1 : 0.2);\n      },\n    });\n    getp = function(p) {\n      return [Math.sin(p) * (that.size - that.thick),\n        -Math.cos(p) * (that.size - that.thick)];\n    };\n    getc = function(p, q, r) {\n      if(typeof(r) == \"undefined\") r = 3;\n      return [\"C\", p[0]/r, p[1]/r, q[0]/r, q[1]/r, q[0], q[1]];\n    }\n    this.svg.selectAll(\"path.chord\").filter(function(d,i) { return !d3.select(this).attr(\"d\"); }).attr({opacity: 0});\n    this.svg.selectAll(\"path.chord\").each(function(d,i) {\n      var node = d3.select(this);\n      if(node.attr(\"d\")) node = node.transition(\"morph\").duration(500);\n      node.attr({\n        d: function(d,i) {\n          var src = d.coord.src, des = d.coord.des;\n          var src1 = that.srcAscale(src.node.offset + src.node.percent * src.offset);\n          var src2 = that.srcAscale(src.node.offset + src.node.percent * (src.offset + src.percent));\n          var des1 = that.desAscale(des.node.offset + des.node.percent * des.offset);\n          var des2 = that.desAscale(des.node.offset + des.node.percent * (des.offset + des.percent));\n          var c1 = 0, c2 = 0;\n          var p1 = getp(src1), p2 = getp(src2), p3 = getp(des1), p4 = getp(des2);\n          var s = that.size - that.thick;\n          return [\n            [\"M\", p1[0], p1[1]],\n            [\"A\", s, s, 0, 0, 0, p2[0], p2[1]],\n            getc(p2, p4),\n            [\"A\", s, s, 0, 0, 0, p3[0], p3[1]],\n            getc(p3, p1)\n          ].reduce(function(a,b) { return a.concat(b); }, []).join(\" \");\n        },\n        fill: function(d,i) {\n          return that.color(d.coord.des.node.key);\n        },\n        stroke: that.config.stroke,\n        \"stroke-width\": that.config.strokeWidth\n      });\n    });\n    this.svg.selectAll(\"path.chord\").transition(\"opacity\").duration(500).attr({\n      opacity: function(d,i) {\n        if(!that.target) return 0.5;\n        if(that.target && (\n          (that.target.side == \"src\" && that.target.src == d.src) ||\n          (that.target.side == \"des\" && that.target.des == d.des) ||\n          (that.target.side == null && that.target.src == d.src && that.target.des == d.des)\n        )) return 1;\n        else return 0.1;\n      }\n    });\n    this.inited = true;\n  }\n}"},"assets":[],"dimension":{"des":{"desc":"name of destination node","type":[],"fields":[],"require":true},"src":{"desc":"name of source node","type":[],"fields":[],"require":true},"size":{"desc":"flow size","type":["Number"],"fields":[],"require":true}},"config":{"thick":{"name":"Thickness","type":[{"name":"Number","level":8,"order":{},"default":0,"basetype":[{"name":"Numstring","level":6,"order":{},"default":"","basetype":[{"name":"Order","level":4,"order":{},"basetype":[{"name":"String","level":2,"default":"","basetype":[]}]}]}]}],"value":20,"default":20},"stroke":{"desc":"Stroke Color","name":"Stroke","type":[{"Gray":"#cccccc","name":"Color","Empty":"#ffffff","level":10,"Neutral":"#cccccc","default":"#dc4521","subtype":{"neutral":"neutral","negative":"negative","positive":"positive"},"Negative":"#d93510","Positive":"#3f7ab5"}],"value":"#ffffff","default":"#fff","category":"Global Settings"},"palette":{"name":"Palette","type":[{"re":{},"name":"Palette","level":30,"scale":{},"binary":{"colors":[{"hex":"#ff8356"},{"hex":"#0076a1"}]},"plotdb":{"colors":[{"hex":"#ed1d78"},{"hex":"#c59b6d"},{"hex":"#8cc63f"},{"hex":"#28aae2"}]},"default":{"colors":[{"hex":"#1d3263"},{"hex":"#226c87"},{"hex":"#f8d672"},{"hex":"#e48e11"},{"hex":"#e03215"},{"hex":"#ab2321"}]},"subtype":{"binary":"binary","diverging":"diverging","sequential":"sequential","qualitative":"qualitative"},"diverging":{"colors":[{"hex":"#74001a"},{"hex":"#cd2149"},{"hex":"#f23971"},{"hex":"#ff84ab"},{"hex":"#ffc3d7"},{"hex":"#f2f2dd"},{"hex":"#b8d9ed"},{"hex":"#81b1d0"},{"hex":"#3d8bb7"},{"hex":"#0071a8"},{"hex":"#003558"}]},"sequential":{"colors":[{"hex":"#950431"},{"hex":"#be043e"},{"hex":"#ec326d"},{"hex":"#fc82a9"},{"hex":"#febed2"},{"hex":"#fee6ee"}]},"qualitative":{"colors":[{"hex":"#c05ae0"},{"hex":"#cf2d0c"},{"hex":"#e9ab1e"},{"hex":"#86ffb5"},{"hex":"#64dfff"},{"hex":"#003f7d"}]}}],"value":{"colors":[{"hex":"#f4502a"},{"hex":"#f1c227"},{"hex":"#008a6d"},{"hex":"#00acdb"},{"hex":"#0064a8"}]},"default":{"colors":[{"hex":"#f4502a"},{"hex":"#f1c227"},{"hex":"#008a6d"},{"hex":"#00acdb"},{"hex":"#0064a8"}]},"category":"Global Settings"},"fontSize":{"name":"Font Size","type":[{"name":"Number","level":8,"order":{},"default":0,"basetype":[{"name":"Numstring","level":6,"order":{},"default":"","basetype":[{"name":"Order","level":4,"order":{},"basetype":[{"name":"String","level":2,"default":"","basetype":[]}]}]}]}],"value":"12","default":13,"category":"Global Settings"},"textFill":{"name":"Text Color","type":[{"Gray":"#cccccc","name":"Color","Empty":"#ffffff","level":10,"Neutral":"#cccccc","default":"#dc4521","subtype":{"neutral":"neutral","negative":"negative","positive":"positive"},"Negative":"#d93510","Positive":"#3f7ab5"}],"value":"#000000","default":"#000000","category":"Global Settings"},"labelShow":{"name":"Show Data Label","type":[{"name":"Boolean","level":8,"order":{},"default":true,"basetype":[{"name":"Order","level":4,"order":{},"basetype":[{"name":"String","level":2,"default":"","basetype":[]}]}]}],"value":true,"default":true,"category":"Label"},"background":{"name":"Background","type":[{"Gray":"#cccccc","name":"Color","Empty":"#ffffff","level":10,"Neutral":"#cccccc","default":"#dc4521","subtype":{"neutral":"neutral","negative":"negative","positive":"positive"},"Negative":"#d93510","Positive":"#3f7ab5"}],"value":"#ffffff","default":"#ffffff","category":"Global Settings"},"fontFamily":{"name":"Font","type":[{"name":"String","level":2,"default":"","basetype":[]}],"value":"Arial","default":"Arial","category":"Global Settings"},"otherLabel":{"name":"Label for 'other'","type":[{"name":"String","level":2,"default":"","basetype":[]}],"value":"Other","default":"Other","category":"Text","rebindOnChange":true},"otherLimit":{"desc":"Data smaller than this value will be clustered into one set of data","name":"Small Data Threshold","type":[{"name":"Number","level":8,"order":{},"default":0,"basetype":[{"name":"Numstring","level":6,"order":{},"default":"","basetype":[{"name":"Order","level":4,"order":{},"basetype":[{"name":"String","level":2,"default":"","basetype":[]}]}]}]}],"value":"50","default":0,"category":"Value","rebindOnChange":true},"strokeWidth":{"desc":"Default Stroke width","name":"Stroke Width","type":[{"name":"Number","level":8,"order":{},"default":0,"basetype":[{"name":"Numstring","level":6,"order":{},"default":"","basetype":[{"name":"Order","level":4,"order":{},"basetype":[{"name":"String","level":2,"default":"","basetype":[]}]}]}]}],"value":"1","default":1,"category":"Global Settings"}},"library":["d3/3.5.12/min","plotd3/0.1.0"],"local":null,"inherit":null}