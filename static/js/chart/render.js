// Generated by LiveScript 1.3.1
var plotdbDomain, brandNew;
plotdbDomain = window.plConfig.urlschema + "" + window.plConfig.domain;
brandNew = true;
window.addEventListener('click', function(){
  return window.parent.postMessage({
    type: 'click',
    payload: ""
  }, plotdbDomain);
});
window.thread = {
  count: 0,
  inc: function(t){
    if (t) {
      return this.count = (this.count || 0) + 1;
    }
  },
  dec: function(t){
    if (t) {
      return this.count = (this.count || 1) - 1;
    }
  },
  racing: function(){
    return this.count > 1;
  }
};
$(document).ready(function(){
  var dispatcher, loadscript, loadlib, properEval, errorHandling, colorblind, configPreset, parse, snapshot, saveLocal, render, resizeHandler;
  dispatcher = function(evt){
    var ref$;
    if ((ref$ = evt.data.type) === 'snapshot' || ref$ === 'getsvg' || ref$ === 'getpng' || ref$ === 'getpng-hd') {
      return snapshot(evt.data.type);
    } else if (evt.data.type === 'render') {
      return render(evt.data.payload, evt.data.rebind);
    } else if (evt.data.type === 'get-sample-data') {
      return window.parent.postMessage({
        type: 'get-sample-data',
        data: window.sampleData || null
      }, plotdbDomain);
    } else if (evt.data.type === 'parse-chart') {
      return parse(evt.data.payload, 'chart');
    } else if (evt.data.type === 'parse-theme') {
      return parse(evt.data.payload, 'theme');
    } else if (evt.data.type === 'reload') {
      if (!brandNew) {
        return window.location.reload();
      } else {
        return window.parent.postMessage({
          type: 'loaded'
        }, plotdbDomain);
      }
    } else if (evt.data.type === 'colorblind-emu') {
      return colorblind(evt.data.payload);
    } else if (evt.data.type === 'edit') {
      return edit(evt.data.payload);
    } else if (evt.data.type === 'get-local') {
      return window.parent.postMessage({
        type: 'get-local',
        data: window.module.exports.local
      }, plotdbDomain);
    }
  };
  window.addEventListener('error', function(e){
    var reBloburl, stack, msg;
    reBloburl = /blobhttp:%3A\/\/[^:]+:/;
    stack = e.error.stack;
    if (reBloburl.exec(stack)) {
      stack = stack.split(reBloburl).join("line ");
      msg = e.message + " at line " + (e.lineno - 1) + ".";
      if (e.message.indexOf(stack) < 0) {
        msg += " Callstack: \n" + stack;
      }
    } else {
      msg = e.message + " at line " + (e.lineno - 1) + ".";
    }
    return errorHandling(msg, e.lineno - 1);
  });
  loadscript = function(lib, url){
    return new Promise(function(res, rej){
      var x$, node;
      x$ = node = document.createElement('script');
      x$.type = 'text/javascript';
      x$.src = url;
      x$.onload = function(){
        return res(lib);
      };
      return document.head.appendChild(node);
    });
  };
  loadlib = function(payload){
    var head, moduleBackup, k, promise, lib, url;
    head = document.getElementsByTagName("head")[0];
    moduleBackup = window.module;
    delete window.module;
    if (!(function(){
      var results$ = [];
      for (k in payload.library || {}) {
        results$.push(k);
      }
      return results$;
    }()).length) {
      payload.library['legacy/0.0.1'] = plotdbDomain + "/js/pack/legacy.js";
    }
    promise = Promise.each((function(){
      var ref$, results$ = [];
      for (lib in ref$ = payload.library) {
        url = ref$[lib];
        results$.push({
          lib: lib,
          url: url
        });
      }
      return results$;
    }()), function(d){
      return loadscript(d.lib, d.url);
    }).then(function(){
      return window.module = moduleBackup;
    });
    return promise;
  };
  properEval = function(code, updateModule){
    updateModule == null && (updateModule = true);
    return new Promise(function(res, rej){
      var empty, module, codeURL, codeNode;
      empty = "{exports:{init:function(){},update:function(){},resize:function(){},bind:function(){},render:function(){}}}";
      window.errorMessage = "";
      module = updateModule ? 'module' : 'moduleLocal';
      if (code[0] === '{') {
        code = "(function() { window." + module + " = {exports:" + code + "}; })()";
      } else {
        code = "(function() { " + code + "; window." + module + " = (typeof(module)=='undefined'?" + empty + ":module); })()";
      }
      window.codeURL = codeURL = URL.createObjectURL(new Blob([code], {
        type: "text/javascript"
      }));
      codeNode = document.createElement("script");
      codeNode.onload = function(){
        var e;
        URL.revokeObjectURL(codeURL);
        if (window[module]) {
          window[module].identity = parseInt(Math.random() * 1000);
        }
        res(window[module]);
        try {
          return document.body.removeChild(codeNode);
        } catch (e$) {
          return e = e$;
        }
      };
      codeNode.src = codeURL;
      return document.body.appendChild(codeNode);
    });
  };
  errorHandling = function(e, lineno){
    var msg, reBloburl, ret, lines;
    lineno == null && (lineno = 0);
    if (!e) {
      msg = "plot failed with unknown error";
    } else if (typeof e !== typeof {}) {
      msg = e + "";
    } else if (!e.stack) {
      msg = e.toString();
    } else {
      msg = e.stack;
    }
    reBloburl = /blob:http%3A\/\/[^:]+:/;
    if (reBloburl.exec(msg)) {
      msg = msg.split(reBloburl).join("line ");
    }
    if (!lineno) {
      ret = /line (\d+):\d+/.exec(msg);
      lineno = ret ? parseInt(ret[1]) : 0;
    }
    if (msg.length > 1024) {
      msg = msg.substring(0, 1024) + "...";
    }
    lines = msg.split('\n');
    if (lines.length > 4) {
      msg = lines.splice(0, 4).join('\n');
    }
    return window.parent.postMessage({
      type: 'error',
      payload: {
        msg: msg,
        lineno: lineno
      }
    }, plotdbDomain);
  };
  colorblind = function(payload){
    var val;
    val = ['normal', 'protanopia', 'protanomaly', 'deuteranopia', 'deuteranomaly', 'tritanopia', 'tritanomaly', 'achromatopsia', 'achromatomaly'];
    if (!in$(payload, val)) {
      payload = 'normal';
    }
    return d3.select('body').style({
      "-webkit-filter": "url('#" + payload + "')",
      "filter": "url('#" + payload + "')"
    });
  };
  configPreset = function(config){
    var k, ref$, v, lresult$, p, field, ref1$, value, results$ = [];
    for (k in ref$ = config || {}) {
      v = ref$[k];
      lresult$ = [];
      p = plotdb.config[k]
        ? k
        : plotdb.config[v.extend] ? v.extend : null;
      if (!p) {
        continue;
      }
      for (field in ref1$ = plotdb.config[p]) {
        value = ref1$[field];
        if (!(v[field] != null)) {
          lresult$.push(v[field] = value);
        }
      }
      results$.push(lresult$);
    }
    return results$;
  };
  parse = function(payload, type){
    return loadlib(payload).then(function(){
      var code, e;
      try {
        code = payload.code;
        if (type === 'chart') {
          return properEval(code, false).then(function(module){
            var chart, payload, ref$;
            chart = module.exports;
            configPreset(chart.config);
            payload = JSON.stringify((ref$ = {}, ref$.dimension = chart.dimension, ref$.config = chart.config, ref$));
            return window.parent.postMessage({
              type: 'parse-chart',
              payload: payload
            }, plotdbDomain);
          });
        } else if (type === 'theme') {
          return properEval(code, false).then(function(module){
            var theme, payload, ref$;
            theme = module.exports;
            payload = JSON.stringify((ref$ = {}, ref$.typedef = theme.typedef, ref$.config = theme.config, ref$));
            return window.parent.postMessage({
              type: 'parse-theme',
              payload: payload
            }, plotdbDomain);
          });
        }
      } catch (e$) {
        e = e$;
        return errorHandling(e);
      }
    });
  };
  snapshot = function(type){
    var allsvg, list, i$, to$, i, g, box, svgnode, styles, idx, style, ref$, width, height, inlineStyle, rate, svg, rgbaPercentToValue, img, encoded, e;
    type == null && (type = 'snapshot');
    try {
      d3.selectAll('#container svg').each(function(){
        var ref$, width, height;
        ref$ = this.getBoundingClientRect(), width = ref$.width, height = ref$.height;
        return d3.select(this).attr({
          "xmlns": "http://www.w3.org/2000/svg",
          "xmlns:xlink": "http://www.w3.org/1999/xlink",
          "width": width,
          "height": height
        });
      });
      allsvg = document.querySelectorAll('#container svg');
      if (allsvg.length > 1) {
        list = Array.from(allsvg).map(function(it){
          var box;
          box = it.getBoundingClientRect();
          return [it.cloneNode(true), (box.right - box.left) * (box.bottom - box.top), it];
        });
        list.sort(function(a, b){
          return b[1] - a[1];
        });
        for (i$ = 1, to$ = list.length; i$ < to$; ++i$) {
          i = i$;
          g = document.createElementNS("http://www.w3.org/2000/svg", "g");
          g.appendChild(list[i][0]);
          list[0][0].insertBefore(g, list[0][0].childNodes[0]);
          box = list[i][2].getBoundingClientRect();
          g.setAttribute("transform", "translate(" + box.left + "," + box.top + ")");
        }
        svgnode = list[0][0];
      } else {
        svgnode = document.querySelector('#container svg').cloneNode(true);
      }
      styles = svgnode.querySelectorAll("style");
      for (i$ = 0, to$ = styles.length; i$ < to$; ++i$) {
        idx = i$;
        style = styles[idx];
        if (!style.generated) {
          continue;
        }
        svgnode.removeChild(style);
      }
      styles = document.querySelectorAll('html style');
      for (i$ = styles.length - 1; i$ >= 0; --i$) {
        idx = i$;
        style = styles[idx].cloneNode(true);
        style.generated = true;
        svgnode.insertBefore(style, svgnode.childNodes[0]);
      }
      ref$ = svgnode.getBoundingClientRect(), width = ref$.width, height = ref$.height;
      inlineStyle = svgnode.getAttribute('style');
      svgnode.setAttribute('style', inlineStyle + ";" + document.getElementById('container').getAttribute('style'));
      svgnode.setAttribute('xmlns', "http://www.w3.org/2000/svg");
      svgnode.setAttribute('xmlns:xlink', "http://www.w3.org/1999/xlink");
      ref$ = svgnode.getBoundingClientRect(), width = ref$.width, height = ref$.height;
      if (!width || !height) {
        width = +(svgnode.getAttribute("width") || 0) || +(svgnode.style.width || "").replace(/[^0-9]+$/, "");
        height = +(svgnode.getAttribute("height") || 0) || +(svgnode.style.height || "").replace(/[^0-9]+$/, "");
      }
      if (type === 'getpng-hd') {
        if (width > 1920 || height > 1920) {
          width = Math.round(width * 2.1);
          height = Math.round(height * 2.1);
        } else {
          rate = 4000 / ((height > width ? width : height) || 1);
          width = width * rate;
          height = height * rate;
        }
        svgnode.setAttribute("width", width);
        svgnode.setAttribute("height", height);
      }
      Array.from(svgnode.querySelectorAll('*')).forEach(function(it){
        if (it.style.opacity === 0 || it.getAttribute('opacity') === 0 || it.getAttribute('display') === 'none' || it.style.display === 'none') {
          return it.parentNode.removeChild(it);
        }
      });
      svg = svgnode.outerHTML;
      rgbaPercentToValue = function(text){
        var re, str, ret, des;
        re = new RegExp(["([a-zA-Z-]+)\\s*", "([=:]?)\\s*(['\"]?)\\s*", "rgba\\(\\s*([0-9.]+%?)\\s*,\\s*([0-9.]+%?)\\s*,\\s*([0-9.]+%?)\\s*,\\s*([0-9.]+)\\s*\\)\\s*\\3"].join(""));
        str = text + "";
        for (;;) {
          ret = re.exec(str);
          if (!ret) {
            break;
          }
          des = [ret[1], ret[2] === ':' ? ':#' : '="#', [ret[4], ret[5], ret[6]].map(fn$).join(''), ret[2] === ':' ? ';' : '" ', ret[1], '-opacity', ret[2] === ':' ? ':' : '="', ret[7], ret[2] === ':' ? '' : '"'].join("");
          text = text.replace(ret[0], des);
          str = str.substring(ret.index + ret[1].length);
        }
        return text;
        function fn$(it){
          var v;
          if (it[it.length - 1] === '%') {
            v = Math.round(it.substring(0, it.length - 1) * 2.55).toString(16);
          } else {
            v = Math.round(+it).toString(16);
          }
          if (v.length < 2) {
            return "0" + v;
          } else {
            return v;
          }
        }
      };
      svg = rgbaPercentToValue(svg);
      svgnode.setAttribute('style', inlineStyle);
      if (type === 'getsvg') {
        return window.parent.postMessage({
          type: 'getsvg',
          payload: svg
        }, plotdbDomain);
      }
      img = new Image();
      img.onload = function(){
        var canvas, ref$;
        canvas = (ref$ = document.createElement("canvas"), ref$.width = width, ref$.height = height, ref$);
        canvas.getContext('2d').drawImage(img, 0, 0, width, height, 0, 0, width, height);
        return window.parent.postMessage({
          type: type,
          payload: canvas.toDataURL()
        }, plotdbDomain);
      };
      encoded = base64.encode(utf8.encode(svg));
      return img.src = "data:image/svg+xml;charset=utf-8;base64," + encoded;
    } catch (e$) {
      e = e$;
      console.log(e);
      return window.parent.postMessage({
        type: type,
        payload: null
      }, plotdbDomain);
    }
  };
  saveLocal = function(chart, key){
    return function(cb){
      var req;
      req = new XMLHttpRequest();
      req.onload = function(){
        if (cb) {
          return cb();
        }
      };
      req.open('put', plotdbDomain + "/e/chart/" + key + "/local", true);
      req.setRequestHeader('Content-Type', "application/json;charset=UTF-8");
      return req.send(JSON.stringify(chart.local));
    };
  };
  render = function(payload, rebind){
    var ref$, code, style, doc, data, assets, local, key, dimension, config, theme, reboot, ret, node, conf, head, foot, iroot, iiroot, margin, marginVertical, promise, e;
    rebind == null && (rebind = true);
    ref$ = ['code', 'style', 'doc'].map(function(it){
      return (payload.chart || (payload.chart = {}))[it].content;
    }), code = ref$[0], style = ref$[1], doc = ref$[2];
    ref$ = ['data', 'assets', 'local', 'key'].map(function(it){
      return payload.chart[it];
    }), data = ref$[0], assets = ref$[1], local = ref$[2], key = ref$[3];
    dimension = payload.chart.dimension || {};
    config = payload.chart.config || {};
    theme = payload.theme || {};
    reboot = !window.module || !window.module.inited || window.module.execError;
    if (reboot) {
      sched.clear();
    }
    thread.inc(reboot);
    try {
      if (false && "script tag disallow") {
        ret = /<\s*script[^>]*>.*<\s*\/\s*script\s*>/g.exec(doc.toLowerCase());
        if (ret) {
          throw new Error("script tag is not allowed in document.");
        }
      }
      if (reboot) {
        node = document.getElementById("wrapper");
        if (!node) {
          node = document.createElement("div");
          node.setAttribute("id", "wrapper");
          node.setAttribute("class", "pdb-root");
          document.body.appendChild(node);
        }
        if (payload.chart.metashow) {
          conf = payload.chart.config;
          ref$ = [0, 0, 0, 0].map(function(){
            return document.createElement("div");
          }), head = ref$[0], foot = ref$[1], iroot = ref$[2], iiroot = ref$[3];
          iroot.appendChild(iiroot);
          ref$ = iroot.style;
          ref$.position = "absolute";
          ref$.left = "0";
          ref$.right = "0";
          ref$ = iiroot.style;
          ref$.width = "100%";
          ref$.height = "100%";
          ref$ = foot.style;
          ref$.position = "absolute";
          ref$.bottom = "0";
          [head, iroot, foot].map(function(it){
            return node.appendChild(it);
          });
          margin = (conf.margin || {
            value: 10
          }).value;
          marginVertical = margin - 10 > 10
            ? margin - 10
            : margin / 2;
          import$(node.style, {
            background: conf.background.value,
            color: conf.textFill.value,
            "font-size": conf.fontSize.value + "px",
            "font-family": (conf.fontFamily || {
              value: "initial"
            }).value
          });
          import$(head.style, {
            position: "relative",
            "z-index": 999,
            "text-align": 'center',
            margin: marginVertical + "px 0 0"
          });
          import$(foot.style, {
            left: margin + "px",
            bottom: marginVertical + "px"
          });
          head.innerHTML = ["<h2 style='margin:0'>" + payload.chart.name + "</h2>", "<p style='margin:0'>" + payload.chart.description + "</p>"].join("");
          if (payload.chart.footer) {
            foot.innerHTML = "<small>" + payload.chart.footer + "</small>";
          }
          import$(iroot.style, {
            top: head.getBoundingClientRect().height + "px",
            bottom: foot.getBoundingClientRect().height + "px"
          });
          node = iiroot;
        }
        $(node).html(["<style type='text/css'>/* <![CDATA[ */" + style + "/* ]]> */</style>", (theme.style || (theme.style = {})).content ? "<style type='text/css'>/* <![CDATA[ */" + theme.style.content + "/* ]]> */</style>" : void 8, "<div id='container' style='position:relative;width:100%;height:100%'>", "<div style='height:0'>&nbsp;</div>", doc, (theme.doc || (theme.doc = {})).content ? theme.doc.content : void 8, "</div>"].join(""));
        promise = loadlib(payload).then(function(){
          return properEval(code);
        });
      } else {
        promise = Promise.resolve(window.module);
      }
      promise.then(function(module){
        var root, chart, k, ref$, v, i$, ref1$, len$, type, e, assetsmap, file, raw, array, j$, to$, idx, promise, this$ = this;
        if (thread.racing()) {
          return thread.dec(reboot);
        }
        root = document.getElementById('container');
        chart = module.exports;
        if (!chart.local) {
          chart.local = local;
        }
        if (chart.sample) {
          if (!window.sampleData) {
            window.sampleData = plotdb.chart.getSampleData(chart, data && data.length ? JSON.parse(JSON.stringify(dimension)) : dimension);
          }
          if (!data || !data.length) {
            data = JSON.parse(JSON.stringify(window.sampleData));
          }
        }
        configPreset(config);
        for (k in ref$ = config || {}) {
          v = ref$[k];
          for (i$ = 0, len$ = (ref1$ = v.type || []).length; i$ < len$; ++i$) {
            type = ref1$[i$];
            try {
              type = plotdb[type.name];
              if (type.test && type.parse && type.test(v.value)) {
                v.value = type.parse(v.value);
                break;
              }
            } catch (e$) {
              e = e$;
              console.log("chart config: type parsing exception ( " + k + " / " + type + " )");
              console.log(e.stack + "");
              thread.dec(reboot);
              return errorHandling("Exception parsing chart config '" + k + "'");
            }
          }
        }
        for (k in ref$ = chart.config) {
          v = ref$[k];
          if (!(config[k] != null) || !(config[k].value != null)) {
            config[k] = (v || config[k] || {})['default'] || 0;
          } else {
            config[k] = config[k].value;
          }
        }
        chart.assets = assetsmap = {};
        for (i$ = 0, len$ = (ref$ = assets).length; i$ < len$; ++i$) {
          file = ref$[i$];
          raw = atob(file.content);
          array = new Uint8Array(raw.length);
          for (j$ = 0, to$ = raw.length; j$ < to$; ++j$) {
            idx = j$;
            array[idx] = raw.charCodeAt(idx);
          }
          file.blob = new Blob([array], {
            type: file.type
          });
          file.url = URL.createObjectURL(file.blob);
          file.datauri = ["data:", file.type, ";charset=utf-8;base64,", file.content].join("");
          assetsmap[file.name] = file;
        }
        chart.config = config;
        chart.saveLocal = saveLocal(chart, key);
        chart.fire = function(){};
        chart.handle = function(name, cb){};
        if (rebind || reboot || !(chart.root && chart.data)) {
          chart.root = root;
          chart.data = data;
          chart.dimension = dimension;
        }
        promise = Promise.resolve();
        if (reboot) {
          promise = promise.then(function(){
            var ret;
            if (thread.racing()) {
              return;
            }
            ret = !module.inited ? (chart.init && chart.init(), chart.parse ? chart.parse() : void 8) : null;
            module.inited = true;
            return ret;
          });
        }
        return promise.then(function(){
          if (thread.racing()) {
            return thread.dec(reboot);
          }
          chart.resize();
          if (rebind || reboot) {
            chart.bind();
          }
          chart.render();
          module.execError = false;
          return window.parent.postMessage({
            type: 'error',
            payload: window.errorMessage || ""
          }, plotdbDomain);
        });
      })['catch'](function(e){
        module.execError = true;
        thread.dec(reboot);
        return errorHandling(e);
      });
    } catch (e$) {
      e = e$;
      thread.dec(reboot);
      errorHandling(e);
    }
    return brandNew = false;
  };
  window.addEventListener('message', dispatcher, false);
  resizeHandler = null;
  window.addEventListener('resize', function(){
    if (resizeHandler) {
      clearTimeout(resizeHandler);
    }
    return resizeHandler = setTimeout(function(){
      var chart;
      resizeHandler = null;
      if (!window.module || !window.module.exports) {
        return;
      }
      chart = window.module.exports;
      chart.resize();
      return chart.render();
    }, 400);
  });
  window.addEventListener('keydown', function(e){
    if ((e.metaKey || e.altKey) && (e.keyCode === 13 || e.which === 13)) {
      return window.parent.postMessage({
        type: 'alt-enter'
      }, plotdbDomain);
    }
  });
  return window.parent.postMessage({
    type: 'loaded'
  }, plotdbDomain);
});
function in$(x, xs){
  var i = -1, l = xs.length >>> 0;
  while (++i < l) if (x === xs[i]) return true;
  return false;
}
function import$(obj, src){
  var own = {}.hasOwnProperty;
  for (var key in src) if (own.call(src, key)) obj[key] = src[key];
  return obj;
}