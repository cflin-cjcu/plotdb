// Generated by LiveScript 1.3.1
var x$;
x$ = angular.module('plotDB');
x$.service('sampleTheme', ['$rootScope'].concat(function($rootScope){
  return plotdb.theme.sample;
}));
x$.service('themeService', ['$rootScope', '$http', 'IOService', 'sampleTheme', 'baseService', 'plUtil', 'plNotify', 'eventBus'].concat(function($rootScope, $http, IOService, sampleTheme, baseService, plUtil, plNotify, eventBus){
  var service, object, ref$, themeService;
  service = {
    sample: sampleTheme,
    link: function(theme){
      return "/theme/?k=" + theme.type.location.charAt(0) + theme.key;
    },
    thumblink: function(theme){
      return "/theme/thumb/?k=" + theme.type.location.charAt(0) + theme.key;
    },
    sharelink: function(theme){
      return "https://plotdb.com" + this.link(theme);
    }
  };
  object = function(){};
  object.prototype = {
    name: 'untitled',
    desc: null,
    tags: null,
    theme: null,
    doc: {
      name: 'document',
      type: 'html',
      content: ((ref$ = service.sample[0]).doc || (ref$.doc = {})).content || ""
    },
    style: {
      name: 'stylesheet',
      type: 'css',
      content: ((ref$ = service.sample[0]).style || (ref$.style = {})).content || ""
    },
    code: {
      name: 'code',
      type: 'javascript',
      content: ((ref$ = service.sample[0]).code || (ref$.code = {})).content || ""
    },
    config: {},
    dimension: {},
    assets: [],
    thumbnail: null,
    isType: false,
    addFile: function(name, type, content){
      var file;
      content == null && (content = null);
      file = {
        name: name,
        type: type,
        content: content
      };
      this.assets.push(file);
      return file;
    },
    removeFile: function(file){
      var idx;
      idx = this.assets.indexOf(file);
      if (idx < 0) {
        return;
      }
      return this.assets.splice(idx, 1);
    }
  };
  themeService = baseService.derive('theme', service, object);
  return themeService;
}));
x$.controller('themeEditor', ['$scope', '$http', '$timeout', '$interval', 'dataService', 'chartService', 'paletteService', 'themeService', 'plNotify'].concat(function($scope, $http, $timeout, $interval, dataService, chartService, paletteService, themeService, plNotify){
  import$($scope, {
    theme: new themeService.theme(),
    showsrc: true,
    vis: 'preview',
    lastvis: null,
    plotdomain: 'http://localhost/',
    error: {
      msg: null,
      lineno: 0
    },
    codemirror: {
      code: {
        lineWrapping: true,
        lineNumbers: true,
        viewportMargin: Infinity,
        mode: 'javascript'
      },
      style: {
        lineWrapping: true,
        lineNumbers: true,
        viewportMargin: Infinity,
        mode: 'css'
      },
      doc: {
        lineWrapping: true,
        lineNumbers: true,
        viewportMargin: Infinity,
        mode: 'xml'
      },
      objs: []
    },
    chart: null,
    canvas: {
      node: document.getElementById('chart-renderer'),
      window: document.getElementById('chart-renderer').contentWindow
    }
  });
  import$($scope, {
    _save: function(nothumb){
      var ref$, refresh, this$ = this;
      nothumb == null && (nothumb = false);
      if (this.theme.owner !== $scope.user.data.key) {
        ref$ = this.theme;
        ref$.key = null;
        ref$.owner = null;
        ref$.permission = themeService.theme.prototype.permission;
      }
      refresh = !this.theme.key ? true : false;
      return this.theme.save().then(function(ret){
        return $scope.$apply(function(){
          var link;
          if (nothumb) {
            plNotify.send('warning', "theme saved, but thumbnail failed to update");
          } else {
            plNotify.send('success', "theme saved");
          }
          link = themeService.link($scope.theme);
          if (refresh || !window.location.search) {
            window.location.href = link;
          }
          if ($scope.save.handle) {
            $timeout.cancel($scope.save.handle);
          }
          return $scope.save.handle = null;
        });
      })['catch'](function(err){
        return $scope.$apply(function(){
          plNotify.aux.error.io('save', 'theme', e);
          console.error("[save theme]", err);
          if ($scope.save.handle) {
            $timeout.cancel($scope.save.handle);
          }
          return $scope.save.handle = null;
        });
      });
    },
    save: function(){
      var this$ = this;
      if (!$scope.user.data || !$scope.user.data.key) {
        return $scope.auth.toggle(true);
      }
      if (this.save.handle) {
        return;
      }
      this.save.handle = $timeout(function(){
        this$.save.handle = null;
        return this$._save(true);
      }, 3000);
      return this.canvas.window.postMessage({
        type: 'snapshot'
      }, this.plotdomain);
    },
    clone: function(){
      var ref$;
      this.theme.name = this.theme.name + " - Copy";
      ref$ = this.theme;
      ref$.key = null;
      ref$.owner = null;
      ref$.permission = chartService.chart.prototype.permission;
      return this.save();
    },
    load: function(type, key){
      var this$ = this;
      return themeService.load(type, key).then(function(ret){
        import$(this$.theme, ret);
        return this$.backup.check();
      })['catch'](function(ret){
        return window.location.href = window.location.pathname;
      });
    },
    'delete': function(){
      var this$ = this;
      if (!this.theme.key) {
        return;
      }
      this['delete'].handle = true;
      return this.theme['delete']().then(function(ret){
        plNotify.send('success', "theme deleted");
        this$.theme = new themeService.theme();
        setTimeout(function(){
          return window.location.href = "/theme/me.html";
        }, 1000);
        return this$['delete'].handle = false;
      })['catch'](function(err){
        plNotify.send('error', "failed to delete theme");
        return this$['delete'].handle = false;
      });
    },
    resetConfig: function(){
      var k, ref$, v, results$ = [];
      if (this.chart) {
        for (k in ref$ = this.chart.config) {
          v = ref$[k];
          results$.push(v.value = v['default']);
        }
        return results$;
      }
    },
    migrate: function(){
      var cloned, this$ = this;
      if (!this.theme.key) {
        return;
      }
      cloned = this.theme.clone();
      cloned.type.location = this.theme.type.location === 'local' ? 'server' : 'local';
      return cloned.save().then(function(){
        return this$.theme['delete']().then(function(){
          $scope.theme = cloned;
          return window.location.href = themeService.link($scope.theme);
        });
      });
    },
    reset: function(){
      return this.render();
    },
    render: function(rebind){
      var k, ref$, v, payload;
      rebind == null && (rebind = true);
      if (!this.chart) {
        return;
      }
      this.chart.updateData();
      for (k in ref$ = this.chart) {
        v = ref$[k];
        if (typeof v !== 'function') {
          this.chart[k] = v;
        }
      }
      for (k in ref$ = this.theme) {
        v = ref$[k];
        if (typeof v !== 'function') {
          this.theme[k] = v;
        }
      }
      payload = JSON.parse(angular.toJson({
        theme: this.theme,
        chart: this.chart
      }));
      ref$ = $scope.render;
      ref$.payload = payload;
      ref$.rebind = rebind;
      if (!rebind) {
        return this.canvas.window.postMessage({
          type: 'render',
          payload: payload,
          rebind: rebind
        }, this.plotdomain);
      } else {
        return this.canvas.window.postMessage({
          type: 'reload'
        }, this.plotdomain);
      }
    },
    renderAsync: function(rebind){
      var this$ = this;
      rebind == null && (rebind = true);
      if (!this.chart) {
        return;
      }
      if (this.renderAsync.handler) {
        $timeout.cancel(this.renderAsync.handler);
      }
      return this.renderAsync.handler = $timeout(function(){
        this$.renderAsync.handler = null;
        return this$.render(rebind);
      }, 500);
    },
    countline: function(){
      var this$ = this;
      return ['code', 'style', 'doc'].map(function(it){
        this$.theme[it].lines = this$.theme[it].content.split('\n').length;
        return this$.theme[it].size = this$.theme[it].content.length;
      });
    },
    download: {
      prepare: function(){
        var this$ = this;
        return ['plotdb'].map(function(n){
          return setTimeout(function(){
            return $scope.$apply(function(){
              return [this$[n].url = '', this$[n]()];
            });
          }, 300);
        });
      },
      plotdb: function(){
        var payload;
        payload = angular.toJson($scope.theme);
        this.plotdb.url = URL.createObjectURL(new Blob([payload], {
          type: 'application/json'
        }));
        return this.plotdb.size = payload.length;
      }
    }
  });
  import$($scope, {
    backup: {
      enabled: false,
      init: function(){
        var this$ = this;
        return $scope.$watch('theme', function(){
          if (!this$.enabled) {
            return;
          }
          if (this$.handle) {
            $timeout.cancel(this$.handle);
          }
          return this$.handle = $timeout(function(){
            this$.handle = null;
            return $scope.theme.backup().then(function(){});
          }, 2000);
        }, true);
      },
      recover: function(){
        var this$ = this;
        if (!this.last || !this.last.object) {
          return;
        }
        $scope.theme.recover(this.last.object);
        this.enabled = false;
        return $scope.theme.cleanBackups().then(function(){
          return $scope.$apply(function(){
            return this$.check();
          });
        });
      },
      check: function(){
        var this$ = this;
        return $scope.theme.backups().then(function(ret){
          return $scope.$apply(function(){
            this$.list = ret;
            this$.last = ret[0];
            return $timeout(function(){
              return this$.enabled = true;
            }, 4000);
          })['catch'](function(err){
            return console.error('fecth backup failed: #', err);
          });
        });
      }
    },
    charts: {
      list: chartService.sample.map(function(it){
        return new chartService.chart(it);
      }),
      set: function(it){
        $scope.chart = it;
        if (!it) {
          return;
        }
        $scope.chart.theme = $scope.theme;
        return $scope.resetConfig();
      }
    },
    editor: {
      'class': "",
      focus: function(){
        var this$ = this;
        return setTimeout(function(){
          return $scope.codemirror.objs.map(function(cm){
            var ret, k, v, this$ = this;
            ret = (function(){
              var ref$, results$ = [];
              for (k in ref$ = $scope.codemirror) {
                v = ref$[k];
                results$.push([k, v]);
              }
              return results$;
            }()).filter(function(it){
              return it[1].mode === cm.options.mode;
            })[0];
            if (!ret || !$scope.vis.startsWith(ret[0])) {
              return;
            }
            setTimeout(function(){
              return cm.focus();
            }, 10);
            if (ret[1].refreshed) {
              return;
            }
            cm.refresh();
            ret[1].refreshed = true;
            return setTimeout(function(){
              cm.refresh();
              if ($scope.error.lineno) {
                return $("#code-editor-code .CodeMirror-code > div:nth-of-type(" + $scope.error.lineno + ")").addClass('error');
              }
            }, 0);
          });
        }, 0);
      },
      update: function(){
        return this['class'] = [this.fullscreen.toggled ? 'fullscreen' : "", this.vis !== 'preview' ? 'active' : "", this.color.modes[this.color.idx]].join(" ");
      },
      fullscreen: {
        toggle: function(){
          this.toggled = !this.toggled;
          $scope.editor.update();
          return $scope.editor.focus();
        },
        toggled: false
      },
      color: {
        modes: ['normal', 'dark'],
        idx: 0,
        toggle: function(){
          this.idx = (this.idx + 1) % this.modes.length;
          return $scope.editor.update();
        }
      }
    },
    settingPanel: {
      toggle: function(){
        return this.toggled = !this.toggled;
      },
      toggled: false
    },
    sharePanel: {
      social: {
        facebook: null
      },
      isForkable: function(){
        var perms, ref$, forkable;
        perms = (ref$ = $scope.theme.permission).value || (ref$.value = []);
        return forkable = !!perms.filter(function(it){
          return it.perm === 'fork' && it['switch'] === 'public';
        }).length;
      },
      init: function(){
        var this$ = this;
        return ['#themeedit-sharelink', '#themeedit-embedcode'].map(function(eventsrc){
          var clipboard;
          clipboard = new Clipboard(eventsrc);
          clipboard.on('success', function(){
            $(eventsrc).tooltip({
              title: 'copied',
              trigger: 'click'
            }).tooltip('show');
            return setTimeout(function(){
              return $(eventsrc).tooltip('hide');
            }, 1000);
          });
          clipboard.on('error', function(){
            $(eventsrc).tooltip({
              title: 'Press Ctrl+C to Copy',
              trigger: 'click'
            }).tooltip('show');
            return setTimeout(function(){
              return $(eventsrc).tooltip('hide');
            }, 1000);
          });
          $scope.$watch('sharePanel.link', function(it){
            var fbobj, k, v, pinobj, emailobj, linkedinobj, twitterobj;
            this$.embedcode = "<iframe src=\"" + it + "\"><iframe>";
            this$.thumblink = themeService.thumblink($scope.theme);
            fbobj = {
              app_id: '1546734828988373',
              display: 'popup',
              caption: $scope.theme.name,
              picture: this$.thumblink,
              link: this$.link,
              name: $scope.theme.name,
              redirect_uri: 'http://plotdb.com/',
              description: $scope.theme.desc || ""
            };
            this$.social.facebook = (["https://www.facebook.com/dialog/feed?"].concat((function(){
              var ref$, results$ = [];
              for (k in ref$ = fbobj) {
                v = ref$[k];
                results$.push(k + "=" + encodeURIComponent(v));
              }
              return results$;
            }()))).join('&');
            pinobj = {
              url: this$.link,
              media: this$.thumblink,
              description: $scope.theme.desc || ""
            };
            this$.social.pinterest = (["https://www.pinterest.com/pin/create/button/?"].concat((function(){
              var ref$, results$ = [];
              for (k in ref$ = pinobj) {
                v = ref$[k];
                results$.push(k + "=" + encodeURIComponent(v));
              }
              return results$;
            }()))).join('&');
            emailobj = {
              subject: "plotdb: " + $scope.theme.name,
              body: $scope.theme.desc + " : " + this$.link
            };
            this$.social.email = (["mailto:?"].concat((function(){
              var ref$, results$ = [];
              for (k in ref$ = emailobj) {
                v = ref$[k];
                results$.push(k + "=" + encodeURIComponent(v));
              }
              return results$;
            }()))).join('&');
            linkedinobj = {
              mini: true,
              url: this$.link,
              title: $scope.theme.name + " on PlotDB",
              summary: $scope.theme.desc,
              source: "plotdb.com"
            };
            this$.social.linkedin = (["http://www.linkedin.com/shareArticle?"].concat((function(){
              var ref$, results$ = [];
              for (k in ref$ = linkedinobj) {
                v = ref$[k];
                results$.push(k + "=" + encodeURIComponent(v));
              }
              return results$;
            }()))).join('&');
            twitterobj = {
              url: this$.link,
              text: $scope.theme.name + " - " + ($scope.theme.desc || ''),
              hashtags: "dataviz,chart,visualization",
              via: "plotdb"
            };
            return this$.social.twitter = (["http://twitter.com/intent/tweet?"].concat((function(){
              var ref$, results$ = [];
              for (k in ref$ = twitterobj) {
                v = ref$[k];
                results$.push(k + "=" + encodeURIComponent(v));
              }
              return results$;
            }()))).join('&');
          });
          $scope.$watch('sharePanel.forkable', function(it){
            var forkable;
            forkable = this$.isForkable();
            if (forkable !== this$.forkable && this$.forkable != null) {
              $scope.theme.permission.value = it
                ? [{
                  'switch': 'public',
                  perm: 'fork'
                }]
                : [];
              return this$.saveHint = true;
            }
          });
          return $scope.$watch('theme.permission.value', function(){
            var forkable;
            forkable = this$.isForkable();
            if (this$.forkable !== forkable && this$.forkable != null) {
              this$.saveHint = true;
            }
            return this$.forkable = forkable;
          }, true);
        });
      },
      saveHint: false,
      embedcode: "",
      link: "",
      toggle: function(){
        if (this.init) {
          this.init();
        }
        this.init = null;
        this.toggled = !this.toggled;
        return this.saveHint = false;
      },
      toggled: false,
      isPublic: function(){
        return in$("public", $scope.theme.permission['switch']);
      },
      setPrivate: function(){
        var ref$;
        ((ref$ = $scope.theme).permission || (ref$.permission = {}))['switch'] = ['private'];
        return this.saveHint = true;
      },
      setPublic: function(){
        var ref$;
        ((ref$ = $scope.theme).permission || (ref$.permission = {}))['switch'] = ['public'];
        return this.saveHint = true;
      }
    },
    coloredit: {
      config: function(v, idx){
        return {
          'class': 'no-palette',
          context: "context" + idx,
          exclusive: true,
          palette: [v.value]
        };
      }
    },
    paledit: {
      convert: function(it){
        return it.map(function(it){
          return {
            id: it.key || Math.random() + "",
            text: it.name,
            data: it.colors
          };
        });
      },
      ldcp: null,
      item: null,
      fromTheme: function(theme){
        var themepal, k, v;
        if (!theme || !theme.config || !theme.config.palette) {
          return this.list = this.list.filter(function(it){
            return it.text !== 'Theme';
          });
        }
        themepal = this.list.filter(function(it){
          return it.text === 'Theme';
        })[0];
        if (!themepal) {
          themepal = {
            text: 'Theme',
            id: '456',
            children: null
          };
          this.list = [themepal].concat(this.list);
        }
        themepal.children = this.convert((function(){
          var ref$, results$ = [];
          for (k in ref$ = theme.config.palette) {
            v = ref$[k];
            results$.push((v.name = k, v));
          }
          return results$;
        }()));
        $('#pal-select option').remove();
        $('#pal-select optgroup').remove();
        return $('#pal-select').select2({
          allowedMethods: ['updateResults'],
          templateResult: function(state){
            var color, c;
            if (!state.data) {
              return state.text;
            }
            color = (function(){
              var i$, ref$, len$, results$ = [];
              for (i$ = 0, len$ = (ref$ = state.data).length; i$ < len$; ++i$) {
                c = ref$[i$];
                results$.push("<div class='color' " + ("style='background:" + c.hex + ";width:" + 100 / state.data.length + "%'") + "></div>");
              }
              return results$;
            }()).join("");
            return $(("<div class='palette select'><div class='name'>" + state.text + "</div>") + ("<div class='palette-color'>" + color + "</div></div>"));
          },
          data: this.list
        });
      },
      init: function(){
        var x$, iconPalSelectConfig, this$ = this;
        this.ldcp = new ldColorPicker(null, {}, $('#palette-editor .editor .ldColorPicker')[0]);
        this.ldcp.on('change-palette', function(){
          return setTimeout(function(){
            return $scope.$apply(function(){
              return this$.update();
            });
          }, 0);
        });
        this.list = [{
          text: 'Default',
          children: this.convert(paletteService.sample)
        }];
        x$ = $('#pal-select');
        x$.select2(iconPalSelectConfig = {
          allowedMethods: ['updateResults'],
          templateResult: function(state){
            var color, c;
            if (!state.data) {
              return state.text;
            }
            color = (function(){
              var i$, ref$, len$, results$ = [];
              for (i$ = 0, len$ = (ref$ = state.data).length; i$ < len$; ++i$) {
                c = ref$[i$];
                results$.push("<div class='color' " + ("style='background:" + c.hex + ";width:" + 100 / state.data.length + "%'") + "></div>");
              }
              return results$;
            }()).join("");
            return $(("<div class='palette select'><div class='name'>" + state.text + "</div>") + ("<div class='palette-color'>" + color + "</div></div>"));
          },
          data: this.list
        });
        x$.on('select2:closing', function(e){
          var i$, ref$, len$, item, ret;
          for (i$ = 0, len$ = (ref$ = this$.list).length; i$ < len$; ++i$) {
            item = ref$[i$];
            ret = item.children.filter(fn$)[0];
            if (ret) {
              break;
            }
          }
          if (!ret) {
            return;
          }
          $scope.$apply(function(){
            return this$.item.value = JSON.parse(JSON.stringify({
              colors: ret.data
            }));
          });
          return this$.ldcp.setPalette(this$.item.value);
          function fn$(it){
            return it.id === $(e.target).val();
          }
        });
        return x$;
      },
      update: function(){
        var src, des, orphan, i$, ref$, len$, item, matched, to$, idx;
        if (this.item) {
          src = this.item.value;
          des = this.ldcp.getPalette();
          orphan = [];
          for (i$ = 0, len$ = (ref$ = src.colors).length; i$ < len$; ++i$) {
            item = ref$[i$];
            matched = des.colors.filter(fn$)[0];
            if (matched) {
              des.colors.splice(des.colors.indexOf(matched), 1);
            }
            if (!matched) {
              orphan.push(item);
            }
          }
          for (i$ = 0, to$ = orphan.length; i$ < to$; ++i$) {
            idx = i$;
            orphan[idx].hex = (des.colors[idx] || {}).hex;
          }
          return src.colors = (des.colors.concat(src.colors)).filter(function(it){
            return it.hex;
          });
        }
        function fn$(it){
          return it.hex === item.hex;
        }
      },
      toggled: false,
      toggle: function(){
        this.toggled = !this.toggled;
        if (!this.toggled) {
          return this.update();
        }
      },
      edit: function(item){
        this.item = item;
        this.ldcp.setPalette(item.value);
        return this.toggled = true;
      }
    },
    switchPanel: function(){
      var this$ = this;
      return setTimeout(function(){
        return $scope.$apply(function(){
          var temp;
          temp = this$.vis;
          if (this$.vis === 'preview' && (!this$.lastvis || this$.lastvis === 'preview')) {
            this$.vis = 'code';
          } else if (this$.vis === 'preview') {
            this$.vis = this$.lastvis;
          } else {
            this$.vis = 'preview';
          }
          return this$.lastvis = temp;
        });
      }, 0);
    },
    hidHandler: function(){
      var this$ = this;
      $scope.codemirrored = function(editor){
        return $scope.codemirror.objs.push(editor);
      };
      return document.body.addEventListener('keydown', function(e){
        if ((e.metaKey || e.altKey) && (e.keyCode === 13 || e.which === 13)) {
          return $scope.$apply(function(){
            return this$.switchPanel();
          });
        }
      });
    },
    checkParam: function(){
      var ret, key, ref$, location;
      if (!window.location.search) {
        return;
      }
      if (window.location.search === '?demo') {
        $scope.theme.doc.content = themeService.sample[1].doc.content;
        $scope.theme.style.content = themeService.sample[1].style.content;
        $scope.theme.code.content = themeService.sample[1].code.content;
        return;
      }
      ret = /[?&]k=([sl])([^&#|?]+)/.exec(window.location.search);
      if (!ret) {
        return;
      }
      key = ret[2];
      ref$ = [ret[1] === 's' ? 'server' : 'local', ret[2]], location = ref$[0], key = ref$[1];
      return $scope.load({
        name: 'theme',
        location: location
      }, key);
    },
    assets: {
      measure: function(){
        return $scope.theme.assets.size = $scope.theme.assets.map(function(it){
          return it.content.length;
        }).reduce(function(a, b){
          return a + b;
        }, 0);
      },
      preview: function(file){
        var datauri, iframe;
        this.preview.toggled = true;
        datauri = ["data:", file.type, ";charset=utf-8;base64,", file.content].join("");
        iframe = document.createElement("iframe");
        $('#assets-preview .iframe')[0].innerHTML = "<iframe></iframe>";
        return $('#assets-preview .iframe iframe')[0].src = datauri;
      },
      read: function(fobj){
        var this$ = this;
        return new Promise(function(res, rej){
          var name, that, type, file, fr;
          name = (that = /([^/]+\.?[^/.]*)$/.exec(fobj.name)) ? that[1] : 'unnamed';
          type = 'unknown';
          file = $scope.theme.addFile(name, type, null);
          fr = new FileReader();
          fr.onload = function(){
            var result, idx, type, content, size;
            result = fr.result;
            idx = result.indexOf(';');
            type = result.substring(5, idx);
            content = result.substring(idx + 8);
            size = $scope.theme.assets.map(function(it){
              return (it.content || "").length;
            }).reduce(function(a, b){
              return a + b;
            }, 0) + content.length;
            if (size > 3000000) {
              $scope.$apply(function(){
                plNotify.alert("Assets size limit (3MB) exceeded. won't upload.");
                $scope.theme.removeFile(file);
              });
            }
            file.type = type;
            file.content = content;
            $scope.$applyAsync(function(){
              return file.type = type, file.content = content, file;
            });
            return res(file);
          };
          return fr.readAsDataURL(fobj);
        });
      },
      handle: function(files){
        var i$, len$, file, results$ = [];
        for (i$ = 0, len$ = files.length; i$ < len$; ++i$) {
          file = files[i$];
          results$.push(this.read(file));
        }
        return results$;
      },
      node: null,
      init: function(){
        var x$, this$ = this;
        x$ = this.node = $('#code-editor-assets input');
        x$.on('change', function(){
          return this$.handle(this$.node[0].files);
        });
        return x$;
      }
    },
    monitor: function(){
      var this$ = this;
      this.assets.init();
      this.$watch('vis', function(vis){
        return $scope.editor.focus();
      });
      this.$watch('theme.assets', function(){
        return this$.assets.measure();
      }, true);
      this.$watch('theme.doc.content', function(){
        return this$.countline();
      });
      this.$watch('theme.style.content', function(){
        return this$.countline();
      });
      this.$watch('theme.code.content', function(){
        return this$.countline();
      });
      this.$watch('theme.doc.content', function(){
        return this$.renderAsync();
      });
      this.$watch('theme.style.content', function(){
        return this$.renderAsync();
      });
      this.$watch('theme', function(theme){
        return this$.renderAsync();
      });
      this.$watch('chart', function(chart){
        this$.renderAsync();
        return this$.theme.chart = chart ? chart.key : null;
      });
      this.$watch('theme.chart', function(key){
        return this$.charts.set(this$.charts.list.filter(function(it){
          return it.key === key;
        })[0]);
      });
      this.$watch('theme.code.content', function(code){
        if (!this$.theme) {
          return;
        }
        if (this$.communicate.parseThemeHandler) {
          $timeout.cancel(this$.communicate.parseThemeHandler);
        }
        return this$.communicate.parseThemeHandler = $timeout(function(){
          this$.communicate.parseThemeHandler = null;
          return this$.canvas.window.postMessage({
            type: 'parse-theme',
            payload: code
          }, this$.plotdomain);
        }, 500);
      });
      this.$watch('chart.config', function(n, o){
        var ret, k, v;
        o == null && (o = {});
        ret = !!(function(){
          var ref$, results$ = [];
          for (k in ref$ = n) {
            v = ref$[k];
            results$.push([k, v]);
          }
          return results$;
        }()).filter(function(arg$){
          var k, v;
          k = arg$[0], v = arg$[1];
          return !o[k] || v.value !== o[k].value;
        }).map(function(){
          return v.rebindOnChange;
        }).filter(function(it){
          return it;
        }).length;
        return this$.renderAsync(ret);
      }, true);
      this.$watch('theme.key', function(){
        return this$.sharePanel.link = themeService.sharelink(this$.theme);
      });
      return $scope.limitscroll($('#chart-configs')[0]);
    },
    communicate: function(){
      var this$ = this;
      return window.addEventListener('message', function(arg$){
        var data;
        data = arg$.data;
        return $scope.$apply(function(){
          var ref$, config, dimension, k, v, variant, payload, rebind, event, bytes, mime, buf, ints, i$, to$, idx;
          if (!data || typeof data !== 'object') {
            return;
          }
          if (data.type === 'error') {
            $('#code-editor-code .CodeMirror-code > .error').removeClass('error');
            $scope.error.msg = (data.payload || (data.payload = {})).msg || "";
            $scope.error.lineno = (data.payload || (data.payload = {})).lineno || 0;
            if ($scope.error.lineno) {
              return $("#code-editor-code .CodeMirror-code > div:nth-of-type(" + $scope.error.lineno + ")").addClass('error');
            }
          } else if (data.type === 'alt-enter') {
            return $scope.switchPanel();
          } else if (data.type === 'snapshot') {
            if (data.payload) {
              this$.theme.thumbnail = data.payload;
            }
            return this$._save();
          } else if (data.type === 'parse') {
            ref$ = JSON.parse(data.payload), config = ref$.config, dimension = ref$.dimension;
            for (k in ref$ = this$.chart.dimension) {
              v = ref$[k];
              if (dimension[k] != null) {
                dimension[k].fields = v.fields;
              }
            }
            for (k in ref$ = this$.chart.config) {
              v = ref$[k];
              if (config[k] != null) {
                config[k].value = v.value;
              }
            }
            for (k in config) {
              v = config[k];
              if (!(v.value != null)) {
                v.value = v['default'];
              }
            }
            ref$ = this$.chart;
            ref$.config = config;
            ref$.dimension = dimension;
            return $scope.render();
          } else if (data.type === 'parse-theme') {
            config = JSON.parse(data.payload).config;
            this$.theme.config = config;
            for (k in ref$ = this$.theme.config) {
              v = ref$[k];
              if (this$.chart.config[k]) {
                variant = this$.chart.config[k].hint || 'default';
                if (this$.theme.config[k][variant] != null) {
                  this$.chart.config[k].value = this$.theme.config[k][variant];
                } else if (this$.theme.config[k]['default']) {
                  this$.chart.config[k].value = this$.theme.config[k]['default'];
                }
              }
            }
            this$.paledit.fromTheme(this$.theme);
            return $scope.render();
          } else if (data.type === 'loaded') {
            if (!this$.chart) {
              return;
            }
            if ($scope.render.payload) {
              payload = $scope.render.payload;
              rebind = $scope.render.rebind;
              this$.canvas.window.postMessage({
                type: 'render',
                payload: payload,
                rebind: rebind
              }, this$.plotdomain);
              return $scope.render.payload = null;
            } else {
              this$.canvas.window.postMessage({
                type: 'parse',
                payload: this$.chart.code.content
              }, this$.plotdomain);
              return this$.canvas.window.postMessage({
                type: 'parse-theme',
                payload: this$.theme.code.content
              }, this$.plotdomain);
            }
          } else if (data.type === 'click') {
            if (document.dispatchEvent) {
              event = document.createEvent('MouseEvents');
              event.initEvent('click', true, true);
              event.synthetic = true;
              return document.dispatchEvent(event);
            } else {
              event = document.createEventObject();
              event.synthetic = true;
              return document.fireEvent("onclick", event);
            }
          } else if (data.type === 'getsvg') {
            if (!data.payload) {
              return $scope.download.svg.url = '#';
            }
            $scope.download.svg.url = URL.createObjectURL(new Blob([data.payload], {
              type: 'image/svg+xml'
            }));
            return $scope.download.svg.size = data.payload.length;
          } else if (data.type === 'getpng') {
            if (!data.payload) {
              return $scope.download.png.url = '#';
            }
            bytes = atob(data.payload.split(',')[1]);
            mime = data.payload.split(',')[0].split(':')[1].split(';')[0];
            if (mime !== 'image/png') {
              return $scope.download.png.url = '#';
            }
            buf = new ArrayBuffer(bytes.length);
            ints = new Uint8Array(buf);
            for (i$ = 0, to$ = bytes.length; i$ < to$; ++i$) {
              idx = i$;
              ints[idx] = bytes.charCodeAt(idx);
            }
            $scope.download.png.url = URL.createObjectURL(new Blob([buf], {
              type: 'image/png'
            }));
            return $scope.download.png.size = bytes.length;
          }
        });
      }, false);
    },
    fieldAgent: {
      init: function(){
        var this$ = this;
        return $('#field-agent').on('mousewheel', function(){
          return this$.setPosition();
        });
      },
      data: null,
      drag: {
        ging: false,
        start: function(){
          return this.ging = true;
        },
        end: function(){
          return this.ging = false;
        }
      },
      setPosition: function(){
        var box, box2, scroll;
        if (!this.node) {
          return;
        }
        box = this.node.getBoundingClientRect();
        box2 = this.node.parentNode.parentNode.getBoundingClientRect();
        scroll = {
          left: $('#data-fields').scrollLeft(),
          top: $('#data-fields').scrollTop()
        };
        return $('#field-agent').css({
          top: (box.top - box2.top + 55 - scroll.top) + "px",
          left: (box.left - box2.left - scroll.left) + "px",
          width: box.width + "px",
          height: box.height + "px"
        });
      },
      setProxy: function(e, data){
        var ref$, node, this$ = this;
        if (this.drag.ging) {
          return;
        }
        ref$ = [data, e.target], this.data = ref$[0], node = ref$[1];
        for (;;) {
          if (node.getAttribute("class").indexOf('data-field') >= 0) {
            break;
          }
          node = node.parentNode;
          if (node.nodeName.toLowerCase() === 'body') {
            return;
          }
        }
        return setTimeout(function(){
          this$.node = node;
          return this$.setPosition();
        }, 0);
      }
    },
    init: function(){
      this.communicate();
      this.hidHandler();
      this.monitor();
      this.checkParam();
      this.paledit.init();
      this.backup.init();
      return this.fieldAgent.init();
    }
  });
  return $scope.init();
}));
x$.controller('themeList', ['$scope', '$http', 'IOService', 'dataService', 'themeService'].concat(function($scope, $http, IOService, dataService, themeService){
  $scope.themes = [];
  return Promise.all([
    new Promise(function(res, rej){
      return IOService.aux.listLocally({
        name: 'theme'
      }, res, rej);
    }), new Promise(function(res, rej){
      return IOService.aux.listRemotely({
        name: 'theme'
      }, res, rej, "q=all");
    })
  ]).then(function(ret){
    var this$ = this;
    return $scope.$apply(function(){
      $scope.themes = ret[0].concat(ret[1]);
      $scope.themes.forEach(function(it){
        return it.width = Math.random() > 0.8 ? 640 : 320;
      });
      return $scope.load = function(theme){
        return window.location.href = themeService.link(theme);
      };
    });
  });
}));
function import$(obj, src){
  var own = {}.hasOwnProperty;
  for (var key in src) if (own.call(src, key)) obj[key] = src[key];
  return obj;
}
function in$(x, xs){
  var i = -1, l = xs.length >>> 0;
  while (++i < l) if (x === xs[i]) return true;
  return false;
}