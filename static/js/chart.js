function import$(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}var x$;x$=angular.module("plotDB"),x$.controller("chartEditor",["$scope","dataService","sampleChart"].concat(function(e,t,n){var r,o;return e.vis="preview",e.showsrc=!0,e.chart={init:function(){return e.chart.code.content=n.code.content},setdim:function(e,n,r){var o;return null==e&&(e={}),(o=t.find(e))?(t.field.update(e),r.fields=[e],this.render()):void 0},render:function(){function t(e){return"Number"===e}var n,r,o,a,i,s,c,l,d,u,f,m,h,p;n=[];for(r in o=this.dimensions||(this.dimensions={})){if(a=o[r],a.fields&&a.fields.length&&a.fields[0].data&&a.fields[0].data.length)break;a=null}if(a)for(i=0,s=a.fields[0].data.length;s>i;++i){c=i,l={};for(r in o=this.dimensions)d=o[r],u=(d.fields||(d.fields=[]))[0],l[d.name]=u?(u.data||(u.data=[]))[c]:null,d.type.filter(t).length&&(l[d.name]=parseFloat(l[d.name]));n.push(l)}return f=import$({},this.configs),h={data:n,config:f},h.doc=(o=e.chart).doc,h.style=o.style,h.code=o.code,m=h,p=document.getElementById("visualizer"),p.contentWindow.postMessage({type:"render",payload:m},"http://localhost/")},doc:{option:{mode:"xml",lineWrapping:!0,lineNumbers:!0},content:""},style:{option:{mode:"css",lineWrapping:!0,lineNumbers:!0},content:""},code:{option:{mode:"javascript",lineWrapping:!0,lineNumbers:!0},content:"function() {}"}},e.chart.init(),setTimeout(function(){return e.chart.render()},1e3),e.$watch("chart.code.content",function(t){function n(e){return e.replace(/plotdb\./,"").trim()}function r(e){return e}function o(e){return e.replace(/plotdb\./,"").trim()}function a(e){return e}var i,s,c,l,d,u,f,m,h,p,g,v,y,x,$,S,w,b,N,I,J;for(i=[t.split("\n"),[],[]],s=i[0],c=i[1],l=i[2],i=[{},{}],d=i[0],u=i[1],f=0,m=0,h=s.length;h>m&&(p=s[m],!/^\s*}\s*,\s*$/.exec(p)||1!==f);++m)1===f&&c.push(p),/^\s*mapping\s*:\s*{\s*$/.exec(p)&&(f=1);for(f=0,m=0,h=s.length;h>m&&(p=s[m],!/^\s*}\s*,\s*$/.exec(p)||1!==f);++m)1===f&&l.push(p),/^\s*config\s*:\s*{\s*$/.exec(p)&&(f=1);for(m=0,h=c.length;h>m;++m)g=c[m],v=/(\S+)\s*:\s*{/.exec(g),v&&(y=v[1],v=/type\s*:\s*\[([^\]]*)\]/.exec(g),v&&(x=v[1].split(",").map(n).filter(r),v=/require: (true|false)/.exec(g),v&&($="true"===v[1]?!0:!1,d[y]={name:y,type:x,require:$})));for(m=0,h=l.length;h>m;++m)S=l[m],v=/(\S+)\s*:\s*{/.exec(S),v&&(y=v[1],v=/type\s*:\s*\[([^\]]*)\]/.exec(S),v&&(x=v[1].split(",").map(o).filter(a),v=/default: ("[^"]+"|'[^']+'|null|\d+)/.exec(S),v&&(w=v[1],u[y]={name:y,type:x,defval:w,value:w})));for(b in d)N=d[b],null==((i=e.chart).dimensions||(i.dimensions={}))[b]&&(((i=e.chart).dimensions||(i.dimensions={}))[b]=N);for(b in i=(I=e.chart).dimensions||(I.dimensions={}))N=i[b],null==d[b]?delete e.chart.dimensions[b]:import$(e.chart.dimensions[b],d[b]);for(b in u)N=u[b],null==((i=e.chart).configs||(i.configs={}))[b]&&(((i=e.chart).configs||(i.configs={}))[b]=N);for(b in i=(I=e.chart).configs||(I.configs={}))N=i[b],null==u[b]?delete e.chart.configs[b]:(J=N.value,import$(N,u[b]),N.value===N.defval&&(N.value=J));return e.chart.render()}),e.$watch("chart.configs",function(){return e.chart.render()},!0),window.addEventListener("message",function(t){var n;return(n=t.data)?"error"===n.type?e.codeError=n.payload:"snapshot"===n.type?(e.chart.thumbnail=n.payload,e.save(e.chart.isType)):void 0:void 0},!1),e.save=function(t){var n,r,o,a,i,s,c,l,d,u,f,m,h;null==t&&(t=!1),n=e.chart,n.thumbnail||visualizer.contentWindow.postMessage({type:"snapshot"},"http://localhost/"),n.isType=t,r={};for(o in a=n.dimensions)for(i=a[o],r[o]=import$({},i),s=0,d=(c=(l=r[o]).fields||(l.fields=[])).length;d>s;++s)u=c[s],delete u.data;if(t)for(o in r)i=r[o],i.fields=[];return f={doc:n.doc.content,style:n.style.content,code:n.code.content,config:n.configs,dimension:r,thumbnail:n.thumbnail,isType:n.isType},f.name=e.name,f.desc=e.desc,m=t?"charttype":"charts",h=JSON.parse(localStorage.getItem("/list/"+m))||[],h.indexOf(e.name)<0&&(h.push(e.name),localStorage.setItem("/list/"+m,angular.toJson(h.filter(function(e){return e})))),localStorage.setItem("/"+m+"/"+e.name,angular.toJson(f)),setTimeout(function(){var t;return t=JSON.parse(localStorage.getItem("/"+m+"/"+e.name))},1e3)},e.load=function(n){var r,o,a,i,s,c,l,d,u,f,m;if(null==n&&(n=e.name),n){for(r=JSON.parse(localStorage.getItem("/charts/"+n)),o=e.chart,o.code.content=r.code,o.doc.content=r.doc,o.style.content=r.style,o.configs=r.config,o.dimensions=r.dimension,a={},i=0,c=(s=t.datasets).length;c>i;++i)l=s[i],a[l.id]=l,l.toggle=!1;for(d in s=r.dimension)for(u=s[d],f=u.fields,u.fields=[],i=0,c=f.length;c>i;++i)m=f[i],e.chart.setdim(m,{},u),a[m.dataset]&&(a[m.dataset].toggle=!0);return o.render()}},e.datacreate=function(){return e.showDataCreateModal=!e.showDataCreateModal},(r=window.location.search)&&(o=/[?&]name=([^&#]+)/.exec(r))?(e.name=o[1],e.load(e.name)):void 0})),x$.controller("mychart",["$scope","dataService"].concat(function(e){var t;return e.mycharts=[],t=JSON.parse(localStorage.getItem("/list/charts"))||[],e.mycharts=t.map(function(e){var t;return t=JSON.parse(localStorage.getItem("/charts/"+e))}).filter(function(e){return e}),e["goto"]=function(e){return window.location.href="/chart.html?name="+e.name}}));