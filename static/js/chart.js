function import$(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}var x$;x$=angular.module("plotDB"),x$.filter("tags",function(){return function(e){return(e||"").split(",")}}),x$.controller("chartEditor",["$scope","dataService","sampleChart"].concat(function(e,t,n){var r,o,a,i;return e.vis="preview",e.showsrc=!0,e.chart={init:function(){return e.chart.code.content=n.code.content},setdim:function(e,n,r){var o;return null==e&&(e={}),(o=t.find(e))?(t.field.update(e),r.fields=[e],this.render()):void 0},render:function(){function t(e){return"Number"===e}var n,r,o,a,i,c,s,l,d,u,f,h,p,m;n=[];for(r in o=this.dimensions||(this.dimensions={})){if(a=o[r],a.fields&&a.fields.length&&a.fields[0].data&&a.fields[0].data.length)break;a=null}if(a)for(i=0,c=a.fields[0].data.length;c>i;++i){s=i,l={};for(r in o=this.dimensions)d=o[r],u=(d.fields||(d.fields=[]))[0],l[d.name]=u?(u.data||(u.data=[]))[s]:null,d.type.filter(t).length&&(l[d.name]=parseFloat(l[d.name]));n.push(l)}return console.log(">",n),f=import$({},this.configs),p={data:n,config:f},p.doc=(o=e.chart).doc,p.style=o.style,p.code=o.code,h=p,m=document.getElementById("visualizer"),m.contentWindow.postMessage({type:"render",payload:h},"http://localhost/")},doc:{option:{mode:"xml",lineWrapping:!0,lineNumbers:!0},content:""},style:{option:{mode:"css",lineWrapping:!0,lineNumbers:!0},content:""},code:{option:{mode:"javascript",lineWrapping:!0,lineNumbers:!0},content:"function() {}"}},e.switchPanel=function(){var t;return t=e.vis,e.vis="preview"===e.vis&&e.oldvis?e.oldvis:"preview"===e.vis?"code":"preview","preview"!==t?e.oldvis=t:void 0},e.codemirrored=function(t){var n;return n=function(){return setTimeout(function(){return e.$apply(function(){return e.swtichPanel()})},10)},t.setOption("extraKeys",{"Cmd-Enter":n,"Alt-Enter":n})},document.body.addEventListener("keydown",function(t){return!t.metaKey&&!t.altKey||13!==t.keyCode&&13!==t.which?void 0:e.$apply(function(){return e.switchPanel()})}),e.chart.init(),setTimeout(function(){return e.chart.render()},1e3),r=function(){var t,n,r,o,a=[];for(t=0,r=(n=["code","style","doc"]).length;r>t;++t)o=n[t],e.chart[o].lines=e.chart[o].content.split("\n").length,a.push(e.chart[o].size=e.chart[o].content.length);return a},e.$watch("chart.doc.content",r),e.$watch("chart.style.content",r),e.$watch("chart.code.content",r),e.$watch("chart.doc.content",function(){return e.chart.render()}),e.$watch("chart.style.content",function(){return e.chart.render()}),e.$watch("chart.code.content",function(t){function n(e){return e.replace(/plotdb\./,"").trim()}function r(e){return e}function o(e){return e.replace(/plotdb\./,"").trim()}function a(e){return e}var i,c,s,l,d,u,f,h,p,m,g,v,y,w,$,x,S,b,N,I,O;for(i=[t.split("\n"),[],[]],c=i[0],s=i[1],l=i[2],i=[{},{}],d=i[0],u=i[1],f=0,h=0,p=c.length;p>h&&(m=c[h],!/^\s*}\s*,\s*$/.exec(m)||1!==f);++h)1===f&&s.push(m),/^\s*mapping\s*:\s*{\s*$/.exec(m)&&(f=1);for(f=0,h=0,p=c.length;p>h&&(m=c[h],!/^\s*}\s*,\s*$/.exec(m)||1!==f);++h)1===f&&l.push(m),/^\s*config\s*:\s*{\s*$/.exec(m)&&(f=1);for(h=0,p=s.length;p>h;++h)g=s[h],v=/(\S+)\s*:\s*{/.exec(g),v&&(y=v[1],v=/type\s*:\s*\[([^\]]*)\]/.exec(g),v&&(w=v[1].split(",").map(n).filter(r),v=/require: (true|false)/.exec(g),v&&($="true"===v[1]?!0:!1,d[y]={name:y,type:w,require:$})));for(h=0,p=l.length;p>h;++h)x=l[h],v=/(\S+)\s*:\s*{/.exec(x),v&&(y=v[1],v=/type\s*:\s*\[([^\]]*)\]/.exec(x),v&&(w=v[1].split(",").map(o).filter(a),v=/default: ("[^"]+"|'[^']+'|null|\d+)/.exec(x),v&&(S=v[1],u[y]={name:y,type:w,defval:S,value:S})));for(b in d)N=d[b],null==((i=e.chart).dimensions||(i.dimensions={}))[b]&&(((i=e.chart).dimensions||(i.dimensions={}))[b]=N);for(b in i=(I=e.chart).dimensions||(I.dimensions={}))N=i[b],null==d[b]?delete e.chart.dimensions[b]:import$(e.chart.dimensions[b],d[b]);for(b in u)N=u[b],null==((i=e.chart).configs||(i.configs={}))[b]&&(((i=e.chart).configs||(i.configs={}))[b]=N);for(b in i=(I=e.chart).configs||(I.configs={}))N=i[b],null==u[b]?delete e.chart.configs[b]:(O=N.value,import$(N,u[b]),N.value===N.defval&&(N.value=O));return e.chart.render()}),e.$watch("chart.configs",function(){return e.chart.render()},!0),window.addEventListener("message",function(t){var n;return(n=t.data)?"error"===n.type?e.codeError=n.payload:"alt-enter"===n.type?e.$apply(function(){return e.vis="code"}):"snapshot"===n.type?(e.chart.thumbnail=n.payload,e.save(e.chart.isType)):void 0:void 0},!1),e.save=function(t){var n,r,o,a,i,c,s,l,d,u,f,h,p;null==t&&(t=!1),n=e.chart,n.thumbnail||visualizer.contentWindow.postMessage({type:"snapshot"},"http://localhost/"),n.isType=t,r={};for(o in a=n.dimensions)for(i=a[o],r[o]=import$({},i),c=0,d=(s=(l=r[o]).fields||(l.fields=[])).length;d>c;++c)u=s[c],delete u.data;if(t)for(o in r)i=r[o],i.fields=[];return f={doc:n.doc.content,style:n.style.content,code:n.code.content,config:n.configs,dimension:r,thumbnail:n.thumbnail,isType:n.isType},f.name=e.name,f.desc=e.desc,f.tags=e.tags,h=t?"charttype":"charts",p=JSON.parse(localStorage.getItem("/list/"+h))||[],p.indexOf(e.name)<0&&(p.push(e.name),localStorage.setItem("/list/"+h,angular.toJson(p.filter(function(e){return e})))),localStorage.setItem("/"+h+"/"+e.name,angular.toJson(f)),setTimeout(function(){var t;return t=JSON.parse(localStorage.getItem("/"+h+"/"+e.name))},1e3)},e.load=function(n,r){var o,a,i,c,s,l,d,u,f,h,p,m;if(null==r&&(r=!1),null==n&&(n=e.name),n){for(o=r?"charttype":"charts",a=JSON.parse(localStorage.getItem("/"+o+"/"+n)),console.log(o,a,n),i=e.chart,i.code.content=a.code,i.doc.content=a.doc,i.style.content=a.style,i.configs=a.config,i.dimensions=a.dimension,e.desc=a.desc,e.tags=a.tags,c={},s=0,d=(l=t.datasets).length;d>s;++s)u=l[s],c[u.id]=u,u.toggle=!1;for(f in l=a.dimension)for(h=l[f],p=h.fields,h.fields=[],s=0,d=p.length;d>s;++s)m=p[s],e.chart.setdim(m,{},h),c[m.dataset]&&(c[m.dataset].toggle=!0);return i.render()}},e.datacreate=function(){return e.showDataCreateModal=!e.showDataCreateModal},(o=window.location.search)&&(a=/[?&]name=([^&#]+)/.exec(o))?(e.name=a[1],a=/[?&]type=([^&#]+)/.exec(window.location.search),i=a&&"true"===a[1]?!0:!1,e.load(e.name,i)):void 0})),x$.controller("mychart",["$scope","dataService"].concat(function(e){var t;return e.mycharts=[],t=JSON.parse(localStorage.getItem("/list/charts"))||[],e.mycharts=t.map(function(e){var t;return t=JSON.parse(localStorage.getItem("/charts/"+e))}).filter(function(e){return e}),e["goto"]=function(e){return window.location.href="/chart.html?name="+e.name}}));