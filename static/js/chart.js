function import$(t,n){var e={}.hasOwnProperty;for(var r in n)e.call(n,r)&&(t[r]=n[r]);return t}var x$;x$=angular.module("plotDB"),x$.filter("tags",function(){return function(t){return(t||"").split(",")}}),x$.filter("length",function(){return function(t){var n;return function(){var e=[];for(n in t)e.push(n);return e}().length}}),x$.service("chartService",["$rootScope","sampleChart","IOService"].concat(function(t,n,e){var r,i;return r=function(t){return null==t&&(t={}),import$(this,t)},r.prototype={name:"untitled",desc:null,tags:null,owner:null,key:null,type:{name:"chart",location:"server"},doc:{name:"document",type:"html",content:n.doc.content},style:{name:"stylesheet",type:"css",content:n.style.content},code:{name:"code",type:"javascript",content:n.code.content},config:{},dimension:{},assets:{},thumbnail:null,isType:!1,save:function(){var t=this;return i.save(this).then(function(n){return import$(t,n)})},sync:function(){var t=this;return i.load(this.type,this.key).then(function(n){return import$(t,n)})},updateData:function(){function t(t){return"Number"===t.name}var n,e,r,i,o,a,c,u,s=[];for(this.data=[],n=Math.max.apply(null,function(){var t,n=[];for(e in t=this.dimension)r=t[e],n.push(r);return n}.call(this).reduce(function(t,n){return t.concat(n.fields||[])},[]).filter(function(t){return t.data}).map(function(t){return t.data.length}).concat([0])),i=0;n>i;++i){o=i,a={};for(e in c=this.dimension)r=c[e],a[e]=(u=(r.fields||(r.fields=[]))[0])?(u.data||(u.data=[]))[o]:null,r.type.filter(t).length&&(a[name]=parseFloat(a[name]));s.push(this.data.push(a))}return s}},i={init:function(){},create:function(t){return new r(t)},save:function(t){return e.save(t)},load:function(t,n){return e.load(t,n)},list:function(t){return null==t&&(t={}),e.list({type:"chart",location:"any"})},sample:n},i.init(),i})),x$.controller("chartEditor",["$scope","$http","$timeout","dataService","chartService"].concat(function(t,n,e,r,i){return import$(t,{showsrc:!0,vis:"preview",lastvis:null,plotdomain:"http://localhost/",error:null,codemirror:{code:{lineWrapping:!0,lineNumbers:!0,mode:"javascript"},style:{lineWrapping:!0,lineNumbers:!0,mode:"css"},doc:{lineWrapping:!0,lineNumbers:!0,mode:"xml"}},chart:i.create(),canvas:{node:document.getElementById("chart-renderer"),window:document.getElementById("chart-renderer").contentWindow}}),import$(t,{save:function(){return i.save(t.chart).then(function(n){return import$(t.chart,n)})},load:function(n,e){return i.load(n,e).then(function(n){return import$(t.chart,n)})},dimension:{bind:function(n,e,i){var o;return null==i&&(i={}),(o=r.find(i))?(r.field.update(i),e.fields=[i],t.render()):void 0}},render:function(){var t,n,e;this.chart.updateData();for(t in n=this.chart)e=n[t],"function"!=typeof e&&(this.chart[t]=e);return this.canvas.window.postMessage({type:"render",payload:this.chart},this.plotdomain)},countline:function(){var t=this;return["code","style","doc"].map(function(n){return t.chart[n].lines=t.chart[n].content.split("\n").length,t.chart[n].size=t.chart[n].content.length})}}),import$(t,{hidHandler:function(){return document.body.addEventListener("keydown",function(n){return!n.metaKey&&!n.altKey||13!==n.keyCode&&13!==n.which?void 0:t.$apply(function(){var t;return t=this.vis,this.vis="preview"===this.vis&&this.lastvis?this.lastvis:"preview"===this.vis?"code":"preview",this.lastvis=t})})},checkParam:function(){var n,e,r,i;if(window.location.search&&(n=/[?&]k=([^&#|]+)\|([^&#]+)/.exec(window.location.search)))return e=[n[1],n[2]],r=e[0],i=e[1],t.load({name:"chart",location:r},i)},monitor:function(){var t=this;return this.$watch("chart.doc.content",function(){return t.countline()}),this.$watch("chart.style.content",function(){return t.countline()}),this.$watch("chart.code.content",function(){return t.countline()}),this.$watch("chart.doc.content",function(){return t.render()}),this.$watch("chart.style.content",function(){return t.render()}),this.$watch("chart.code.content",function(n){return t.canvas.window.postMessage({type:"parse",payload:n},t.plotdomain)}),this.$watch("chart.config",function(){return t.render()},!0)},communicate:function(){var n=this;return window.addEventListener("message",function(e){var r,i,o,a,c,u;if(r=e.data,r&&"object"==typeof r){if("error"===r.type)return t.$apply(function(){return t.error=r.payload});if("alt-enter"===r.type)return t.$apply(function(){return t.vis="code"});if("snapshot"===r.type)return t.chart.thumbnail=r.payload,t.chart.save();if("parse"===r.type){i=JSON.parse(r.payload),o=i.config,a=i.dimension;for(c in i=n.chart.dimension)u=i[c],null!=a[c]&&(a[c].fields=u.fields);for(c in i=n.chart.config)u=i[c],null!=o[c]&&(o[c].value=u.value);for(c in o)u=o[c],null==u.value&&(u.value=u["default"]);return i=n.chart,i.config=o,i.dimension=a,t.render()}return"loaded"===r.type?n.canvas.window.postMessage({type:"parse",payload:n.chart.code.content},n.plotdomain):void 0}},!1)},init:function(){return this.communicate(),this.hidHandler(),this.monitor(),this.checkParam()}}),t.init()})),x$.controller("mychart",["$scope","$http","dataService"].concat(function(t,n){var e;return t.mycharts=[],e=JSON.parse(localStorage.getItem("/list/chart"))||[],t.mycharts=e.map(function(t){var n;return n=JSON.parse(localStorage.getItem("/chart/"+t))}).filter(function(t){return t}),n({url:"/d/chart/",method:"GET"}).success(function(n){return console.log(n),t.mycharts=t.mycharts.concat(n)}),t["goto"]=function(t){return window.location.href="/chart.html?key="+t.key}}));