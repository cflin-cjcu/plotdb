function import$(t,e){var n={}.hasOwnProperty;for(var o in e)n.call(e,o)&&(t[o]=e[o]);return t}var x$;x$=angular.module("plotDB"),x$.filter("tags",function(){return function(t){return(t||"").split(",")}}),x$.controller("chartEditor",["$scope","$http","$timeout","dataService","sampleChart"].concat(function(t,e,n,o,r){var a,c,i,s,d;return t.plotdomain="http://localhost/",t.vis="preview",t.showsrc=!0,t.chart={init:function(){return t.chart.code.content=r.code.content},setdim:function(t,e,n){var r;return null==t&&(t={}),(r=o.find(t))?(o.field.update(t),n.fields=[t],this.render()):void 0},render:function(){function e(t){return"Number"===t.name}var n,o,r,a,c,i,s,d,l,u,h,f,p,m,y;n=[];for(o in r=this.dimensions||(this.dimensions={})){if(a=r[o],a.fields&&a.fields.length&&a.fields[0].data&&a.fields[0].data.length)break;a=null}if(a)for(c=0,i=a.fields[0].data.length;i>c;++c){s=c,d={};for(l in r=this.dimensions)u=r[l],h=(u.fields||(u.fields=[]))[0],d[l]=h?(h.data||(h.data=[]))[s]:null,u.type.filter(e).length&&(d[l]=parseFloat(d[l]));n.push(d)}return f=import$({},this.configs),m={data:n,config:f},m.doc=(r=t.chart).doc,m.style=r.style,m.code=r.code,p=m,y=document.getElementById("visualizer"),y.contentWindow.postMessage({type:"render",payload:p},t.plotdomain)},doc:{option:{mode:"xml",lineWrapping:!0,lineNumbers:!0},content:""},style:{option:{mode:"css",lineWrapping:!0,lineNumbers:!0},content:""},code:{option:{mode:"javascript",lineWrapping:!0,lineNumbers:!0},content:"function() {}"}},t.switchPanel=function(){var e;return e=t.vis,t.vis="preview"===t.vis&&t.oldvis?t.oldvis:"preview"===t.vis?"code":"preview","preview"!==e?t.oldvis=e:void 0},t.codemirrored=function(t){var e;return e=function(){},t.setOption("extraKeys",{"Cmd-Enter":e,"Alt-Enter":e})},document.body.addEventListener("keydown",function(e){return!e.metaKey&&!e.altKey||13!==e.keyCode&&13!==e.which?void 0:t.$apply(function(){return t.switchPanel()})}),t.chart.init(),a=function(){var e,n,o,r,a=[];for(e=0,o=(n=["code","style","doc"]).length;o>e;++e)r=n[e],t.chart[r].lines=t.chart[r].content.split("\n").length,a.push(t.chart[r].size=t.chart[r].content.length);return a},t.$watch("chart.doc.content",a),t.$watch("chart.style.content",a),t.$watch("chart.code.content",a),t.$watch("chart.doc.content",function(){return t.chart.render()}),t.$watch("chart.style.content",function(){return t.chart.render()}),t.$watch("chart.code.content",function(e){return visualizer.contentWindow.postMessage({type:"parse",payload:e},t.plotdomain)}),t.$watch("chart.configs",function(){return t.chart.render()},!0),window.addEventListener("message",function(e){var n,o,r,a,c,i,s;if(n=e.data,n&&typeof n==typeof{}){if("error"===n.type)return t.$apply(function(){return t.codeError=n.payload});if("alt-enter"===n.type)return t.$apply(function(){return t.vis="code"});if("snapshot"===n.type)return t.chart.thumbnail=n.payload,t.save(t.chart.isType);if("parse"===n.type){o=JSON.parse(n.payload),r=o.config,a=o.mapping;for(c in o=(i=t.chart).configs||(i.configs={}))s=o[c],r[c]&&(r[c].value=s.value);for(c in r)s=r[c],r[c].value||(r[c].value=r[c]["default"]);for(c in o=(i=t.chart).dimensions||(i.dimensions={}))s=o[c],a[c]&&(a[c].fields=s.fields);return o=t.chart,o.dimensions=a,o.configs=r,t.chart.render()}return"loaded"===n.type?visualizer.contentWindow.postMessage({type:"parse",payload:((o=t.chart).code||(o.code={})).content},t.plotdomain):void 0}},!1),t.save=function(n){var o,r,a,c,s,d,l,u,h,f,p,m,y;null==n&&(n=!1),o=t.chart,o.thumbnail||visualizer.contentWindow.postMessage({type:"snapshot"},t.plotdomain),o.isType=n,r={};for(a in c=o.dimensions)for(s=c[a],r[a]=import$({},s),d=0,h=(l=(u=r[a]).fields||(u.fields=[])).length;h>d;++d)f=l[d],delete f.data;if(n)for(a in r)s=r[a],s.fields=[];return p={key:o.key,doc:{name:"document",type:"html",content:o.doc.content},style:{name:"stylesheet",type:"css",content:o.style.content},code:{name:"code",type:"javascript",content:o.code.content},config:o.configs,dimension:r,thumbnail:o.thumbnail,isType:o.isType},p.name=t.name,p.desc=t.desc,p.tags=t.tags,p.owner=null,m=n?"charttype":"chart",y=p.key?{url:"/d/"+m+"/"+p.key,method:"PUT",data:p}:{url:"/d/"+m,method:"POST",data:p},console.log(y),e(y).success(function(t){return console.log("success",t),o.key=t.key}).error(function(){return console.log("error",i)})},t.load=function(n,r){var a,c,i,s;return null==r&&(r=!1),n?(a=r?"charttype":"chart",c=function(e){var n,r,a,c,i,s,d,l,u,h;for(console.log(e),n=t.chart,n.code.content=e.code.content,n.doc.content=e.doc.content,n.style.content=e.style.content,n.configs=e.config,n.dimensions=e.dimension,t.desc=e.desc,t.tags=e.tags,r={},a=0,i=(c=o.datasets).length;i>a;++a)s=c[a],r[s.key]=s,s.toggle=!1;for(d in c=e.dimension)for(l=c[d],u=l.fields,l.fields=[],a=0,i=u.length;i>a;++a)h=u[a],t.chart.setdim(h,{},l),r[h.dataset]&&(r[h.dataset].toggle=!0);return n.render()},i=JSON.parse(localStorage.getItem(n+"")),s=new Promise(i?function(t){return t(i)}:function(t){return e({url:"/d/chart/"+n,method:"GET"}).success(function(e){return t(e)}).error(function(t){return console.log("ERROR Loading chart: ",t)})}),s.then(function(t){return c(t)})):void 0},t.datacreate=function(){return t.showDataCreateModal=!t.showDataCreateModal},(c=window.location.search)&&(i=/[?&]key=([^&#]+)/.exec(c))?(s=i[1],i=/[?&]type=([^&#]+)/.exec(window.location.search),d=i&&"true"===i[1]?!0:!1,t.load(s,d)):void 0})),x$.controller("mychart",["$scope","$http","dataService"].concat(function(t,e){var n;return t.mycharts=[],n=JSON.parse(localStorage.getItem("/list/chart"))||[],t.mycharts=n.map(function(t){var e;return e=JSON.parse(localStorage.getItem("/chart/"+t))}).filter(function(t){return t}),e({url:"/d/chart/",method:"GET"}).success(function(e){return console.log(e),t.mycharts=t.mycharts.concat(e)}),t["goto"]=function(t){return window.location.href="/chart.html?key="+t.key}}));