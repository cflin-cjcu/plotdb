function in$(e,t){for(var n=-1,r=t.length>>>0;++n<r;)if(e===t[n])return!0;return!1}function import$(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}var x$;x$=angular.module("plotDB"),x$.service("IOService",["$rootScope","$http"].concat(function(e,t){var n,r;return n={usedkey:{},localkey:function(){return(Math.random().toString(36)+"").substring(2)},saveLocally:function(e,t,n){var r,o,a,l;if(r=JSON.parse(localStorage.getItem("/db/list/"+e.type.name))||[],!e.key){for(o=0;10>=o&&(a=o,l=this.localkey(),10!==a&&(in$(l,r)||this.usedkey[l]));++o);if(10===a)return n([!0,"generate local key failed"]);e.key=l,this.usedkey[l]=!0}return e.key&&!in$(e.key,r)&&r.push(e.key),e[e.createdTime?"modifiedTime":"createdTime"]=(new Date).getTime(),localStorage.setItem("/db/list/"+e.type.name,angular.toJson(r)),localStorage.setItem("/db/"+e.type.name+"/"+e.key,angular.toJson(e)),t(e)},saveRemotely:function(e,n,r){var o;return e[e.createdTime?"modifiedTime":"createdTime"]=(new Date).getTime(),o=import$({data:e},e.key?{url:"/d/"+e.type.name+"/"+e.key,method:"PUT"}:{url:"/d/"+e.type.name,method:"POST"}),t(o).success(function(e){return n(e)}).error(function(e){return r([!0,e.toString()])})},loadLocally:function(e,t,n,r){var o;return o=JSON.parse(localStorage.getItem("/db/"+e.name+"/"+t)),o?n(o):r([!0,"no such item"])},loadRemotely:function(e,n,r,o){var a;return a={url:"/d/"+e.name+"/"+n,method:"GET"},t(a).success(function(e){return r(e)}).error(function(e){return o([!0,e.toString()])})},deleteLocally:function(e,t,n,r){var o;return o=JSON.parse(localStorage.getItem("/db/list/"+e.name))||[],in$(t,o)?(o=o.filter(function(e){return e!==t}),localStorage.setItem("/db/list/"+e.name,angular.toJson(o)),localStorage.setItem("/db/"+e.name+"/"+t,null),n()):r([!0,"no such item"])},deleteRemotely:function(e,n,r,o){var a;return a={url:"/d/"+e.name+"/"+n,method:"DELETE"},t(a).success(function(e){return r(e)}).error(function(e){return null==e&&(e=""),o([!0,e.toString()])})},listLocally:function(e,t){var n,r,o,a,l,u;for(n=JSON.parse(localStorage.getItem("/db/list/"+e.name))||[],r=[],o=0,a=n.length;a>o;++o)l=n[o],u=JSON.parse(localStorage.getItem("/db/"+e.name+"/"+l)),u&&u.key&&r.push(u);return t(r)},listRemotely:function(e,n,r,o){return null==o&&(o=null),t({url:"/d/"+e.name+(o?"?"+o:""),method:"GET"}).success(function(e){return n(e)}).error(function(e){return r([!0,e.toString()])})},verifyType:function(e){return e&&e.type&&"object"==typeof e.type&&e.type.name&&e.type.location?!1:!0}},r={aux:n,save:function(e){return new Promise(function(t,r){return n.verifyType(e)?r([!0,"type incorrect"]):"local"===e.type.location?n.saveLocally(e,t,r):"server"===e.type.location?n.saveRemotely(e,t,r):r([!0,"not support type"])})},load:function(e,t){return new Promise(function(r,o){return n.verifyType({type:e})?o([!0,"type incorrect"]):"local"===e.location?n.loadLocally(e,t,r,o):"server"===e.location?n.loadRemotely(e,t,r,o):o([!0,"not support type"])})},list:function(e,t){return null==t&&(t={}),new Promise(function(t,r){return n.verifyType({type:e})?r([!0,"type incorrect"]):"local"===e.location?n.listLocally(e,t,r):"server"===e.location?n.listRemotely(e,t,r):"any"===e.location?Promise.all([new Promise(function(t,r){return n.listLocally(e,t,r)}),new Promise(function(t,r){return n.listRemotely(e,t,r)})]).then(function(e){return t(e[0].concat(e[1]))}):r([!0,"not support type"])})},"delete":function(e,t){return new Promise(function(r,o){return e&&t?"local"===e.location?n.deleteLocally(e,t,r,o):"server"===e.location?n.deleteRemotely(e,t,r,o):o([!0,"not support type"]):o([!0,"param not sufficient"])})},backup:function(e){return new Promise(function(t){var n,r;return n="/db/backup/"+e.type.name+"/"+e.key,r=0,localStorage.setItem(n+"/count",angular.toJson(r+1)),localStorage.setItem(n+"/"+r,angular.toJson(e)),localStorage.setItem(n+"/"+r+"/timestamp",angular.toJson((new Date).getTime())),t()})},backups:function(e){return new Promise(function(t){var n,r,o,a,l,u,c;for(n="/db/backup/"+e.type.name+"/"+e.key,r=parseInt(localStorage.getItem(n+"/count")||0),o=[],a=0;r>a;++a)l=a,u=JSON.parse(localStorage.getItem(n+"/"+l)||""),c=JSON.parse(localStorage.getItem(n+"/"+l+"/timestamp")||"0"),o.push({object:u,timestamp:c});return t(o)})},cleanBackups:function(e){return new Promise(function(t){var n;return n="/db/backup/"+e.type.name+"/"+e.key,localStorage.setItem(n+"/count","0"),t()})}}}));