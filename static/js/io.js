function in$(e,t){for(var n=-1,r=t.length>>>0;++n<r;)if(e===t[n])return!0;return!1}function import$(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}var x$;x$=angular.module("plotDB"),x$.service("IOService",["$rootScope","$http"].concat(function(e,t){var n,r;return n={usedkey:{},localkey:function(){return(Math.random().toString(36)+"").substring(2)},saveLocally:function(e,t,n){var r,o,l,a;if(r=JSON.parse(localStorage.getItem("/db/list/"+e.type.name))||[],!e.key){for(o=0;10>=o&&(l=o,a=this.localkey(),10!==l&&(in$(a,r)||this.usedkey[a]));++o);if(10===l)return n([!0,"generate local key failed"]);e.key=a,this.usedkey[a]=!0}return e.key&&!in$(e.key,r)&&r.push(e.key),localStorage.setItem("/db/list/"+e.type.name,angular.toJson(r)),localStorage.setItem("/db/"+e.type.name+"/"+e.key,angular.toJson(e)),t(e)},saveRemotely:function(e,n,r){var o;return o=import$({data:e},e.key?{url:"/d/"+e.type.name+"/"+e.key,method:"PUT"}:{url:"/d/"+e.type.name,method:"POST"}),t(o).success(function(e){return n(e)}).error(function(e){return r([!0,e.toString()])})},loadLocally:function(e,t,n){var r;return r=JSON.parse(localStorage.getItem("/db/"+e.name+"/"+t)),n(r)},loadRemotely:function(e,n,r,o){var l;return l={url:"/d/"+e.name+"/"+n,method:"GET"},t(l).success(function(e){return r(e)}).error(function(e){return o([!0,e.toString()])})},deleteLocally:function(e,t,n,r){var o;return o=JSON.parse(localStorage.getItem("/db/list/"+e.name))||[],in$(t,o)?(o=o.filter(function(e){return e!==t}),localStorage.setItem("/db/list/"+e.name,angular.toJson(o)),n()):r([!0,"no such item"])},deleteRemotely:function(e,n,r,o){var l;return l={url:"/d/"+e.name+"/"+n,method:"DELETE"},t(l).success(function(e){return r(e)}).error(function(e){return null==e&&(e=""),o([!0,e.toString()])})},listLocally:function(e,t){var n,r,o,l,a,u;for(n=JSON.parse(localStorage.getItem("/db/list/"+e.name))||[],r=[],o=0,l=n.length;l>o;++o)a=n[o],u=JSON.parse(localStorage.getItem("/db/"+e.name+"/"+a)),u&&u.key&&r.push(u);return t(r)},listRemotely:function(e,n,r){return t({url:"/d/"+e.name,method:"GET"}).success(function(e){return n(e)}).error(function(e){return r([!0,e.toString()])})},verifyType:function(e){return e&&e.type&&"object"==typeof e.type&&e.type.name&&e.type.location?!1:!0}},r={save:function(e){return new Promise(function(t,r){return n.verifyType(e)?r([!0,"type incorrect"]):"local"===e.type.location?n.saveLocally(e,t,r):"server"===e.type.location?n.saveRemotely(e,t,r):r([!0,"not support type"])})},load:function(e,t){return new Promise(function(r,o){return n.verifyType({type:e})?o([!0,"type incorrect"]):"local"===e.location?n.loadLocally(e,t,r,o):"server"===e.location?n.loadRemotely(e,t,r,o):o([!0,"not support type"])})},list:function(e,t){return null==t&&(t={}),new Promise(function(t,r){return n.verifyType({type:e})?r([!0,"type incorrect"]):"local"===e.location?n.listLocally(e,t,r):"server"===e.location?n.listRemotely(e,t,r):"any"===e.location?Promise.all([new Promise(function(t,r){return n.listLocally(e,t,r)}),new Promise(function(t,r){return n.listRemotely(e,t,r)})]).then(function(e){return t(e[0].concat(e[1]))}):r([!0,"not support type"])})},"delete":function(e,t){return new Promise(function(r,o){return e&&t?"local"===e.location?n.deleteLocally(e,t,r,o):"server"===e.location?n.deleteRemotely(e,t,r,o):o([!0,"not support type"]):o([!0,"param not sufficient"])})}}}));