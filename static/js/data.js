var x$;x$=angular.module("plotDB"),x$.service("sampleData",["$rootScope"].concat(function(){return[{name:"Population2015.csv",size:"456KB",rows:"72",color:"#f99",key:1,fields:[{name:"population",type:"Number",file:1},{name:"date",type:"Date",file:1}]},{name:"Agriculture.csv",size:"73KB",rows:"15",color:"#9f9",key:2,fields:[{name:"ratio",type:"Percent",file:2},{name:"area",type:"Number",file:2},{name:"revenue",type:"Number",file:2}]}]})),x$.service("dataService",["$rootScope","sampleData"].concat(function(e,t){var n;return n={datasets:[].concat(t),name:function(e){return"/datasets/"+e},init:function(){var e,t,n,r,a,o,s=[];try{for(e=JSON.parse(localStorage.getItem("/list/datasets")||null)||[],t=0,n=e.length;n>t;++t)r=e[t],a=JSON.parse(localStorage.getItem(this.name(r))||null),a&&s.push(this.datasets.push(a));return s}catch(i){return o=i,console.log(o.toString())}},save:function(e,t){var n,r;return null==t&&(t=!0),n=this.datasets.map(function(e){return e.name}).indexOf(e.name),n>=0&&this.datasets.splice(n,1),t&&(localStorage.setItem(this.name(e.name),JSON.stringify(e)),r=JSON.parse(localStorage.getItem("/list/datasets")||null)||[],r.indexOf(e.name)<0&&r.push(e.name),localStorage.setItem("/list/datasets",JSON.stringify(r))),this.datasets.push(e)},"delete":function(e){var t,n;return t=this.datasets.indexOf(e),0>t||(this.datasets.splice(t,1),n=JSON.parse(localStorage.getItem("/list/datasets")),!n||(t=n.indexOf(e.name),0>t))?void 0:(n.splice(t,1),localStorage.setItem("/list/datasets",JSON.stringify(n)),localStorage.setItem(this.name(e.name),null))}},n.init(),n})),x$.controller("dataEditor",["$scope","$timeout","$http","dataService"].concat(function(e,t,n,r){return e.editor={raw:"",handler:null,data:null,parse:function(){return e.handler=null,this.data=Papa.parse(e.editor.raw,{header:!0}).data,this.rows=this.data.length,this.size=this.raw.length,this.sizetext=this.size<1e3?this.size+"bytes":this.size<1048576?parseInt(this.size/102.4)/10+"KB":parseInt(this.size/104857.6)/10+"MB"},build:function(t){var n,r;return{name:this.name,size:this.size,rows:this.rows,color:"#ccc",key:e.datasets.length,data:this.data,isLocal:t,fields:function(){var e,t=[];for(n in e=this.data[0])r=e[n],t.push([n,r]);return t}.call(this).map(function(t){return{name:t[0],type:"String",file:e.datasets.length}})}},save:function(e){var t;return null==e&&(e=!0),t=this.build(e),r.save(t,e)}},e.$watch("editor.raw",function(){return e.editor.data=null,e.handler&&t.cancel(e.handler),e.handler=t(function(){return e.editor.parse()},1e3)}),e.datasets=r.datasets,e.removedata=function(e){return r["delete"](e)},e.CSVEncoding="UTF-8",e.uploadFromCSV=function(){return setTimeout(function(){return $("#fromCSVModal").modal("show")},0)},e.readCSV=function(){var t,n;return t=$("#CSVFile")[0].files[0],n=new FileReader,n.onload=function(t){return e.$apply(function(){return e.editor.raw=t.target.result.trim()}),$("#fromCSVModal").modal("hide")},n.onerror=function(){},n.readAsText(t,e.CSVEncoding)},e.uploadFromLink=function(){return setTimeout(function(){return $("#fromLinkModal").modal("show")},0)},e.readLink=function(){return n({url:"http://crossorigin.me/"+e.linkURL,method:"GET"}).success(function(t){return e.editor.raw=t.trim(),$("#fromLinkModal").modal("hide")})},e.uploadFromSpreadsheet=function(){return setTimeout(function(){return $("#fromSpreadsheetModal").modal("show")},0)},e.readSpreadsheet=function(){var t,r,a;return(t=/\/d\/([^\/]+)/.exec(e.spreadsheetURL))?(r=t[1],a=function(t){var n;return n=t.map(function(e){return e.map(function(e){return'"'+(e.replace(/[\r\n]/,"")||" ")+'"'}).join(",")}).join("\n"),e.text=n,$("#fromSpreadsheetModal").modal('hide"')},console.log("https://spreadsheets.google.com/feeds/list/"+r+"/1/public/values?alt=json"),n({url:"https://spreadsheets.google.com/feeds/list/"+r+"/1/public/values?alt=json",method:"GET"}).success(function(t){var n,r,a,o;n={},t.feed.entry.map(function(e){var t,r,a=[];for(t in e)(r=/^gsx\$(.+)$/.exec(t))&&a.push(n[r[1]]=1);return a}),r=[];for(a in n)r.push(a);return n=r,o=[n.join(",")].concat(t.feed.entry.map(function(e){var t;return function(){var r,a,o,s=[];for(r=0,o=(a=n).length;o>r;++r)t=a[r],s.push((e["gsx$"+t]||{$t:""}).$t);return s}().join(",")})),e.editor.raw=o.join("\n"),setTimeout(function(){return $("#fromSpreadsheetModal").modal("hide")},0)}).error(function(){return a([])})):void 0}}));