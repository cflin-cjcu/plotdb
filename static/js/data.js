var x$;x$=angular.module("plotDB"),x$.service("sampleData",["$rootScope"].concat(function(){return[{name:"Population2015.csv",size:"456KB",rows:"72",color:"#f99",key:1,fields:[{name:"population",type:"Number",file:1},{name:"date",type:"Date",file:1}]},{name:"Agriculture.csv",size:"73KB",rows:"15",color:"#9f9",key:2,fields:[{name:"ratio",type:"Percent",file:2},{name:"area",type:"Number",file:2},{name:"revenue",type:"Number",file:2}]}]})),x$.service("dataService",["$rootScope","sampleData"].concat(function(e,t){var r;return r={datasets:[].concat(t),name:function(e){return"/datasets/"+e},local:{rows:0,size:0},init:function(){var e,t,r,n,a,o;this.local.rows=0,this.local.size=0;try{for(e=JSON.parse(localStorage.getItem("/list/datasets")||null)||[],t=0,r=e.length;r>t;++t)n=e[t],a=JSON.parse(localStorage.getItem(this.name(n))||null),a&&(this.local.rows+=a.rows,this.local.size+=a.size,this.datasets.push(a));return this.local.sizetext=this.verboseSize(this.local.size)}catch(s){return o=s,console.log(o.toString())}},find:function(e){var t;return(t=this.datasets.filter(function(t){return t.key===e.file})[0])?e=t.fields.filter(function(t){return t.name===e.name})[0]:null},save:function(e,t){var r,n;return null==t&&(t=!0),r=this.datasets.map(function(e){return e.name}).indexOf(e.name),r>=0&&this.datasets.splice(r,1),t&&(localStorage.setItem(this.name(e.name),JSON.stringify(e)),n=JSON.parse(localStorage.getItem("/list/datasets")||null)||[],n.indexOf(e.name)<0&&n.push(e.name),localStorage.setItem("/list/datasets",JSON.stringify(n))),this.datasets.push(e)},"delete":function(e){var t,r;return t=this.datasets.indexOf(e),0>t||(this.datasets.splice(t,1),r=JSON.parse(localStorage.getItem("/list/datasets")),!r||(t=r.indexOf(e.name),0>t))?void 0:(r.splice(t,1),localStorage.setItem("/list/datasets",JSON.stringify(r)),localStorage.setItem(this.name(e.name),null))},verboseSize:function(e){return 1e3>e?e+"bytes":1048576>e?parseInt(e/102.4)/10+"KB":parseInt(e/104857.6)/10+"MB"}},r.init(),r})),x$.controller("dataCreateCtrl",["$scope","$timeout","$http","dataService"].concat(function(e,t,r,n){return e.editor={raw:"",handler:null,data:null,parse:function(){return e.handler=null,this.data=Papa.parse(e.editor.raw,{header:!0}).data,this.rows=this.data.length,this.size=this.raw.length,this.sizetext=n.verboseSize(this.size)},build:function(t){var r,n;return{name:this.name,size:this.size,rows:this.rows,color:"#ccc",key:e.datasets.length,data:this.data,isLocal:t,fields:function(){var e,t=[];for(r in e=this.data[0])n=e[r],t.push([r,n]);return t}.call(this).map(function(t){return{name:t[0],type:"String",file:e.datasets.length}})}},save:function(e){var t;return null==e&&(e=!0),t=this.build(e),n.save(t,e)}},e.$watch("editor.raw",function(){return e.editor.data=null,e.handler&&t.cancel(e.handler),e.handler=t(function(){return e.editor.parse()},1e3)}),e.datasets=n.datasets,e.CSVEncoding="UTF-8",e.uploadFromCSV=function(){return setTimeout(function(){return $("#fromCSVModal").modal("show")},0)},e.readCSV=function(){var t,r;return t=$("#CSVFile")[0].files[0],r=new FileReader,r.onload=function(t){return e.$apply(function(){return e.editor.raw=t.target.result.trim()}),$("#fromCSVModal").modal("hide")},r.onerror=function(){},r.readAsText(t,e.CSVEncoding)},e.uploadFromLink=function(){return setTimeout(function(){return $("#fromLinkModal").modal("show")},0)},e.readLink=function(){return r({url:"http://crossorigin.me/"+e.linkURL,method:"GET"}).success(function(t){return e.editor.raw=t.trim(),$("#fromLinkModal").modal("hide")})},e.uploadFromSpreadsheet=function(){return setTimeout(function(){return $("#fromSpreadsheetModal").modal("show")},0)},e.readSpreadsheet=function(){var t,n,a;return(t=/\/d\/([^\/]+)/.exec(e.spreadsheetURL))?(n=t[1],a=function(t){var r;return r=t.map(function(e){return e.map(function(e){return'"'+(e.replace(/[\r\n]/,"")||" ")+'"'}).join(",")}).join("\n"),e.text=r,$("#fromSpreadsheetModal").modal('hide"')},console.log("https://spreadsheets.google.com/feeds/list/"+n+"/1/public/values?alt=json"),r({url:"https://spreadsheets.google.com/feeds/list/"+n+"/1/public/values?alt=json",method:"GET"}).success(function(t){var r,n,a,o;r={},t.feed.entry.map(function(e){var t,n,a=[];for(t in e)(n=/^gsx\$(.+)$/.exec(t))&&a.push(r[n[1]]=1);return a}),n=[];for(a in r)n.push(a);return r=n,o=[r.join(",")].concat(t.feed.entry.map(function(e){var t;return function(){var n,a,o,s=[];for(n=0,o=(a=r).length;o>n;++n)t=a[n],s.push((e["gsx$"+t]||{$t:""}).$t);return s}().join(",")})),e.editor.raw=o.join("\n"),setTimeout(function(){return $("#fromSpreadsheetModal").modal("hide")},0)}).error(function(){return a([])})):void 0}})),x$.controller("dataEditor",["$scope","$timeout","$http","dataService"].concat(function(){})),x$.controller("dataFiles",["$scope","dataService"].concat(function(e,t){return e.datasets=t.datasets,e.removedata=function(e){return t["delete"](e)}}));