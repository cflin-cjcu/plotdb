function import$(e,n){var t={}.hasOwnProperty;for(var r in n)t.call(n,r)&&(e[r]=n[r]);return e}function in$(e,n){for(var t=-1,r=n.length>>>0;++t<r;)if(e===n[t])return!0;return!1}var bluebird,model,ref$;bluebird=require("bluebird"),ref$=function(e){var n,t,r,i,u;return this.config=e,this.name=(n=this.config).name,this.range=n.range,t=e.defaultFields,t===!0?(n=[model.type.user,model.type.id,model.type.permission],r=n[0],i=n[1],u=n[2]):"object"==typeof t&&(n={user:t.user,key:t.key,permission:t.permission},r=n.user,i=n.key,u=n.permission),r&&(((n=this.config).base||(n.base={})).owner={required:!0,type:model.type.key({type:r})}),i&&(((n=this.config).base||(n.base={})).key={required:!1,type:i}),u&&(this.config.base.permission={required:!0,type:u}),this},ref$.prototype={_validate:function(e,n,t){var r,i;if(n.required&&null==t)return[!0,e,"required"];if(null==t)return[!1];if(n.type&&(r=n.type.lint(t),!r||r[0]))return[!0,e,"type",r];if(n.max||n.min)if(n.type&&n.type.range){if(r=n.type.range({min:n.min,max:n.max},t),r[0])return r[1]=e,r}else{if(i=null!=t.length?t.length:t,n.max&&i>n.max)return[!0,e,"max"];if(n.min&&i<n.min)return[!0,e,"min"]}return[!1]},validate:function(e){function n(){var n,t,r=[];for(o in n=(t=this.config).base||(t.base={}))l=n[o],r.push([o,l,e[o]]);return r}var t,r,i,u,o,l,a,f;if((t=this.config.self)&&(r=this._validate(null,t,e),r[0]))return r;for(i=0,a=(u=[[null,this.config.self,e]].concat(n.call(this))).length;a>i;++i)if(f=u[i],f[1]&&(r=this._validate(f[0],f[1],f[2]),r[0]))return r;return[!1]},lint:function(e){var n;return n=this.validate(e),!n||n[0]?n:this.config.lint?this.config.lint(e):[!1,null,null]},clean:function(e){var n,t=this;return(n=this.config.clean)&&(e=n(e)),this["interface"]&&import$((e.getType=function(){return t},e),this["interface"]),e},create:function(){var e,n,t,r,i,u,o;e={};for(n in t=(r=this.config).base||(r.base={}))i=t[n],null!=i["default"]?e[n]=i["default"]:(u=((r=(o=i.type||(i.type={})).config||(o.config={})).self||(r.self={}))["default"])&&(e[n]=u);return e=(u=this.config.create)?u(e):e,this.clean(e)},expand:function(e){var n=this;return new bluebird(function(t){var r;return((r=n.config.expand)?r(e):new bluebird(function(n){return n(e)})).then(function(e){var r,i,u;return r=e?function(){var e,n,t=[];for(i in e=(n=this.config).base||(n.base={}))u=e[i],t.push([i,u]);return t}.call(n).filter(function(n){return n[1].type&&e[n[0]]}).map(function(n){var t;return t=n[1].type.expand(e[n[0]]),t.then(function(t){return e[n[0]]=t})}):[],r.length?bluebird.all(r).then(function(){return t(e)}):t(e)})})},shrink:function(e){var n,t,r,i,u;(n=this.config.shrink)&&(e=n(e));for(t in r=(i=this.config).base||(i.base={}))u=r[t],e[t]&&(e[t]=u.type.shrink(e[t]));return e}},model=ref$,model.type=import$({},{"boolean":new model({lint:function(e){return[!(!e||typeof e==typeof!0)]}}),string:new model({lint:function(e){return[!("string"==typeof e||"number"==typeof e)]},range:function(e,n){var t,r,i;return t=e.min,r=e.max,i=(n+"").length,t>i?[!0,null,"min"]:i>r?[!0,null,"max"]:[!1]}}),email:new model({lint:function(e){return[!(e&&"string"==typeof e&&/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]+/.exec(e))]}}),number:new model({lint:function(e){return[!("number"==typeof e)]}}),date:new model({lint:function(e){return"string"==typeof e&&!isNaN(new Date(e))&&e.length<50?[!1]:[isNaN(e)]}}),array:function(e){return new model({lint:function(n){var t,r;return typeof n!=typeof[]||isNaN(parseInt(n.length))?[!0]:(t=function(){var t,i,u=[];for(t=0,i=n.length;i>t;++t)r=t,u.push([r,e.type.lint(n[r])]);return u}().filter(function(e){return e[1][0]})[0],t?[!0,t[0],t[1]]:[!1])}})},key:function(e){return new model({lint:function(e){return typeof e==typeof{}||"string"==typeof e?[!1]:[!0,null,"type"]},expand:function(n){return"string"==typeof n?e.type.expand(n):void 0}})},keys:function(e){return new model({lint:function(e){var n,t;return typeof e!=typeof[]||isNaN(parseInt(e.length))?[!0]:(n=function(){var n,r,i=[];for(n=0,r=e.length;r>n;++n)t=n,i.push([t,e[t]]);return i}().filter(function(e){return!e[1]})[0],n?[!0,n[0],n[1]]:[!1])},expand:function(n){var t,r;return t=function(){var t,i,u=[];for(t=0,i=n.length;i>t;++t)r=t,u.push([r,e.type.expand(n[r])]);return u}().map(function(e){return e[1].then(function(t){return n[e[0]]=t})}),new bluebird(function(e){return bluebird.all(t).then(function(){return e(n)})})},shrink:function(n){var t,r,i,u=[];for(t=0,r=n.length;r>t;++t)i=t,u.push(n[i]=e.type.shrink(n[i]));return u}})},id:new model({lint:function(){return[!1]}})}),import$(model.type,{permission:new model({name:"permission",switches:["private","public","list","token"],permtype:["read","fork","write","admin"],lint:function(e){var n,t,r,i;if(!e)return[!0,null,"ISNULL"];if("object"!=typeof e)return[!0,null,"NOTOBJ"];if(null==e["switch"]||!Array.isArray(e["switch"]))return[!0,null,"switch"];if(null==e.value||!Array.isArray(e.value))return[!0,null,"value"];for(n=0,r=(t=e["switch"]).length;r>n;++n)if(i=t[n],!in$(i,model.type.permission.config.switches))return[!0,i["switch"],"switch"];for(n=0,r=(t=e.value).length;r>n;++n){if(i=t[n],"object"!=typeof i)return[!0,i,"value"];if(!in$(i["switch"],model.type.permission.config.switches))return[!0,i["switch"],"switch"];if(!in$(i.perm,model.type.permission.config.permtype))return[!0,i.perm,"permtype"]}return[!1]}}),user:new model({name:"user",base:{username:{required:!0,type:model.type.email},password:{type:model.type.string},usepasswd:{type:model.type["boolean"]},displayname:{max:30,min:3,required:!0,type:model.type.string},desc:{max:1e3,type:model.type.string},create_date:{type:model.type.date},public_email:{type:model.type["boolean"]},avatar:{max:300,type:model.type.string}},expand:function(e){return new bluebird(typeof e==typeof{}?function(n){return n(e)}:function(n){return store.read("user",e).then(function(e){return["password","usepasswd","username","_id"].map(function(n){var t;return t=e[n],delete e[n],t}),n(e)})})}})}),module.exports=model;